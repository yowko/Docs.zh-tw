---
title: 可檢視性模式
description: 雲端原生應用程式的可檢視性模式
ms.date: 09/23/2019
ms.openlocfilehash: 23320144c03278d631b8a1fcc1d1c0954e907296
ms.sourcegitcommit: 55f438d4d00a34b9aca9eedaac3f85590bb11565
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/23/2019
ms.locfileid: "71184873"
---
# <a name="observability-patterns"></a><span data-ttu-id="a10da-103">可檢視性模式</span><span class="sxs-lookup"><span data-stu-id="a10da-103">Observability patterns</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="a10da-104">就像是為了協助應用程式中的程式碼配置而開發的模式一樣，應用程式的模式也是以可靠的方式運作。</span><span class="sxs-lookup"><span data-stu-id="a10da-104">Just as patterns have been developed to aid in the layout of code in applications, there are patterns for operating applications in a reliable way.</span></span> <span data-ttu-id="a10da-105">維護應用程式有三個有用的模式：記錄、監視和警示。</span><span class="sxs-lookup"><span data-stu-id="a10da-105">Three useful patterns in maintaining applications have emerged: logging, monitoring, and alerts.</span></span>

## <a name="when-to-use-logging"></a><span data-ttu-id="a10da-106">使用記錄的時機</span><span class="sxs-lookup"><span data-stu-id="a10da-106">When to use logging</span></span>

<span data-ttu-id="a10da-107">不管我們的重要性，應用程式在生產環境中幾乎一律以非預期的方式表現。</span><span class="sxs-lookup"><span data-stu-id="a10da-107">No matter how careful we are, applications almost always behave in unexpected ways in production.</span></span> <span data-ttu-id="a10da-108">當使用者回報應用程式的問題時，在問題發生時，可以查看應用程式的情況會非常有用。</span><span class="sxs-lookup"><span data-stu-id="a10da-108">When users report problems with an application, it's extremely useful to be able to see what was going on with the app when the problem occurred.</span></span> <span data-ttu-id="a10da-109">在執行應用程式時，最常嘗試和真正的方法之一，就是讓應用程式寫下它的運作。</span><span class="sxs-lookup"><span data-stu-id="a10da-109">One of the most tried and true ways of capturing information about what an application is doing while it's running is to have the application write down what it's doing.</span></span> <span data-ttu-id="a10da-110">此程式稱為記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-110">This process is known as logging.</span></span> <span data-ttu-id="a10da-111">在生產環境中發生任何失敗或問題時，目標應該是在非生產環境中重現發生失敗的條件。</span><span class="sxs-lookup"><span data-stu-id="a10da-111">Anytime failures or problems occur in production, the goal should be to reproduce the conditions under which the failures occurred, in a non-production environment.</span></span> <span data-ttu-id="a10da-112">備妥良好的記錄功能，可讓開發人員遵循此藍圖，以在可以測試和實驗的環境中重複問題。</span><span class="sxs-lookup"><span data-stu-id="a10da-112">Having good logging in place provides a roadmap for developers to follow in order to duplicate problems in an environment that can be tested and experimented with.</span></span>

### <a name="logging-in-cloud-native-applications"></a><span data-ttu-id="a10da-113">雲端原生應用程式中的記錄</span><span class="sxs-lookup"><span data-stu-id="a10da-113">Logging in cloud-native applications</span></span>

<span data-ttu-id="a10da-114">每種程式設計語言都有允許寫入記錄的工具，而且通常寫入這些記錄檔的額外負荷很低。</span><span class="sxs-lookup"><span data-stu-id="a10da-114">Every programming language has tooling that permits writing logs, and typically the overhead for writing these logs is low.</span></span> <span data-ttu-id="a10da-115">許多記錄程式庫都提供記錄不同種類的嚴重性，可在執行時間進行調整。</span><span class="sxs-lookup"><span data-stu-id="a10da-115">Many of the logging libraries provide logging different kinds of criticalities, which can be tuned at run time.</span></span> <span data-ttu-id="a10da-116">例如，Serilog 程式庫是適用于 .NET 的熱門結構化記錄程式庫，提供下列記錄層級</span><span class="sxs-lookup"><span data-stu-id="a10da-116">For instance, the Serilog library is a popular structured logging library for .NET that provides the following logging levels</span></span>

* <span data-ttu-id="a10da-117">詳細資訊</span><span class="sxs-lookup"><span data-stu-id="a10da-117">Verbose</span></span>
* <span data-ttu-id="a10da-118">偵錯</span><span class="sxs-lookup"><span data-stu-id="a10da-118">Debug</span></span>
* <span data-ttu-id="a10da-119">資訊</span><span class="sxs-lookup"><span data-stu-id="a10da-119">Information</span></span>
* <span data-ttu-id="a10da-120">警告</span><span class="sxs-lookup"><span data-stu-id="a10da-120">Warning</span></span>
* <span data-ttu-id="a10da-121">錯誤</span><span class="sxs-lookup"><span data-stu-id="a10da-121">Error</span></span>
* <span data-ttu-id="a10da-122">時發生</span><span class="sxs-lookup"><span data-stu-id="a10da-122">Fatal</span></span>

<span data-ttu-id="a10da-123">這些不同的記錄層級會在記錄中提供細微性。</span><span class="sxs-lookup"><span data-stu-id="a10da-123">These different log levels provide granularity in logging.</span></span> <span data-ttu-id="a10da-124">當應用程式在生產環境中正常運作時，可能會將它設定為只記錄重要的訊息。</span><span class="sxs-lookup"><span data-stu-id="a10da-124">When the application is functioning properly in production, it may be configured to only log important messages.</span></span> <span data-ttu-id="a10da-125">當應用程式行為不佳時，可以增加記錄層級，以收集更詳細的記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-125">When the application is misbehaving, then the log level can be increased so more verbose logs are gathered.</span></span> <span data-ttu-id="a10da-126">這會平衡效能，使其易於進行調試。</span><span class="sxs-lookup"><span data-stu-id="a10da-126">This balances performance against ease of debugging.</span></span>

<span data-ttu-id="a10da-127">記錄工具的高效能和詳細資訊的 tunability 應該鼓勵開發人員經常記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-127">The high performance of logging tools and the tunability of verbosity should encourage developers to log frequently.</span></span> <span data-ttu-id="a10da-128">許多偏好記錄每個方法的專案和結束的模式。</span><span class="sxs-lookup"><span data-stu-id="a10da-128">Many favor a pattern of logging the entry and exit of each method.</span></span> <span data-ttu-id="a10da-129">這種方法聽起來可能像大材小用，但是開發人員不常想要進行較少的記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-129">This approach may sound like overkill, but it's infrequent that developers will wish for less logging.</span></span> <span data-ttu-id="a10da-130">事實上，針對在有問題的方法加入記錄的唯一目的來執行部署並不常見。</span><span class="sxs-lookup"><span data-stu-id="a10da-130">In fact, it's not uncommon to perform deployments for the sole purpose of adding logging around a problematic method.</span></span> <span data-ttu-id="a10da-131">在記錄太多的那一邊錯誤，而不是太少。</span><span class="sxs-lookup"><span data-stu-id="a10da-131">Err on the side of too much logging and not on too little.</span></span> <span data-ttu-id="a10da-132">請注意，有些工具可以用來自動提供這種記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-132">Note that some tools can be used to automatically provide this kind of logging.</span></span>

<span data-ttu-id="a10da-133">在傳統的應用程式中，記錄檔通常會儲存在本機電腦上。</span><span class="sxs-lookup"><span data-stu-id="a10da-133">In traditional applications, log files were typically stored on the local machine.</span></span> <span data-ttu-id="a10da-134">事實上，在 Unix 之類的作業系統上，有一個資料夾結構定義為保存任何記錄檔，通常是在`/var/log`底下。</span><span class="sxs-lookup"><span data-stu-id="a10da-134">In fact, on Unix-like operating systems, there's a folder structure defined to hold any logs, typically under `/var/log`.</span></span> <span data-ttu-id="a10da-135">在單一電腦上記錄到一般檔案的實用性，在雲端環境中大幅降低。</span><span class="sxs-lookup"><span data-stu-id="a10da-135">The usefulness of logging to a flat file on a single machine is vastly reduced in a cloud environment.</span></span> <span data-ttu-id="a10da-136">產生記錄檔的應用程式可能無法存取本機磁片，或本機磁片可能是高度暫時性的，因為容器會在實體機器上隨機移動。</span><span class="sxs-lookup"><span data-stu-id="a10da-136">Applications producing logs may not have access to the local disk or the local disk may be highly transient as containers are shuffled around physical machines.</span></span>

<span data-ttu-id="a10da-137">使用微服務架構開發的雲端原生應用程式也會對以檔案為基礎的記錄器造成一些挑戰。</span><span class="sxs-lookup"><span data-stu-id="a10da-137">Cloud-native applications developed using a microservices architecture also pose some challenges for file-based loggers.</span></span> <span data-ttu-id="a10da-138">使用者要求現在可能會跨越在不同電腦上執行的多個服務，而且可能包含無伺服器功能，完全不需要本機檔案系統的存取權。</span><span class="sxs-lookup"><span data-stu-id="a10da-138">User requests may now span multiple services that are run on different machines, and may include serverless functions with no access to a local file system at all.</span></span> <span data-ttu-id="a10da-139">將來自使用者或會話的記錄與這些服務和電腦之間的相互關聯是非常困難的。</span><span class="sxs-lookup"><span data-stu-id="a10da-139">It would be very challenging to correlate the logs from a user or a session across these many services and machines.</span></span>

<span data-ttu-id="a10da-140">最後，某些雲端原生應用程式中的使用者數目很高。</span><span class="sxs-lookup"><span data-stu-id="a10da-140">Finally, the number of users in some cloud-native applications is high.</span></span> <span data-ttu-id="a10da-141">假設每個使用者登入應用程式時，都會產生一百行的記錄訊息。</span><span class="sxs-lookup"><span data-stu-id="a10da-141">Imagine that each user generates a hundred lines of log messages when they log into an application.</span></span> <span data-ttu-id="a10da-142">在隔離中，這是可管理的，但超過100000的使用者和記錄量會變大。</span><span class="sxs-lookup"><span data-stu-id="a10da-142">In isolation, that is manageable, but multiply that over 100,000 users and the volume of logs becomes large.</span></span>

<span data-ttu-id="a10da-143">幸好，有一些絕佳的替代方法可以使用以檔案系統為基礎的記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-143">Fortunately, there are some fantastic alternatives to using file system-based logging.</span></span> <span data-ttu-id="a10da-144">所有記錄傳送到其中的集中式記錄伺服器，會修正所有這些問題。</span><span class="sxs-lookup"><span data-stu-id="a10da-144">A centralized log server to which all logs are sent, fixes all these problems.</span></span> <span data-ttu-id="a10da-145">記錄是由應用程式所收集，並隨附于中央記錄應用程式來編制索引並儲存記錄。</span><span class="sxs-lookup"><span data-stu-id="a10da-145">Logs are collected by the applications and shipped to a central logging application which indexes and stores the logs.</span></span> <span data-ttu-id="a10da-146">這個類別的系統每天可以內嵌數十 gb 的記錄檔。</span><span class="sxs-lookup"><span data-stu-id="a10da-146">This class of system can ingest tens of gigabytes of logs every day.</span></span>

<span data-ttu-id="a10da-147">在建立橫跨許多服務的記錄時，遵循一些標準做法也會很有説明。</span><span class="sxs-lookup"><span data-stu-id="a10da-147">It's also helpful to follow some standard practices when building logging that spans many services.</span></span> <span data-ttu-id="a10da-148">比方說，在冗長的互動開始時產生相互[關聯識別碼](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/)，然後在與該互動相關的每個訊息中進行記錄，可讓您更輕鬆地搜尋所有相關的訊息。</span><span class="sxs-lookup"><span data-stu-id="a10da-148">For instance, generating a [correlation ID](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/) at the start of a lengthy interaction, and then logging it in each message that is related to that interaction, makes it easier to search for all related messages.</span></span> <span data-ttu-id="a10da-149">其中一個只需要尋找單一訊息，並將相互關聯識別碼解壓縮，以尋找所有相關訊息。</span><span class="sxs-lookup"><span data-stu-id="a10da-149">One need only find a single message and extract the correlation ID to find all the related messages.</span></span> <span data-ttu-id="a10da-150">另一個範例是確保每個服務（其所使用的語言或記錄程式庫）的記錄格式都相同。</span><span class="sxs-lookup"><span data-stu-id="a10da-150">Another example is ensuring that the log format is the same for every service, whatever the language or logging library it uses.</span></span> <span data-ttu-id="a10da-151">這種標準化可以讓讀取記錄檔更容易。</span><span class="sxs-lookup"><span data-stu-id="a10da-151">This standardization makes reading logs much easier.</span></span> <span data-ttu-id="a10da-152">圖7-1 示範微服務架構如何運用集中式記錄做為其工作流程的一部分。</span><span class="sxs-lookup"><span data-stu-id="a10da-152">Figure 7-1 demonstrates how a microservices architecture can leverage centralized logging as part of its workflow.</span></span>

<span data-ttu-id="a10da-153">![來自各種來源的記錄會內嵌到集中式記錄存放區。**圖 7-1**。 ](./media/centralized-logging.png)
</span><span class="sxs-lookup"><span data-stu-id="a10da-153">![Logs from various sources are ingested into a centralized log store.](./media/centralized-logging.png)
**Figure 7-1**.</span></span> <span data-ttu-id="a10da-154">來自各種來源的記錄會內嵌到集中式記錄存放區。</span><span class="sxs-lookup"><span data-stu-id="a10da-154">Logs from various sources are ingested into a centralized log store.</span></span>

## <a name="when-to-use-monitoring"></a><span data-ttu-id="a10da-155">使用監視的時機</span><span class="sxs-lookup"><span data-stu-id="a10da-155">When to use monitoring</span></span>

<span data-ttu-id="a10da-156">有些應用程式不是要徑任務。</span><span class="sxs-lookup"><span data-stu-id="a10da-156">Some applications aren't mission-critical.</span></span> <span data-ttu-id="a10da-157">也許它們只會在內部使用，當問題發生時，使用者可以聯絡負責的小組，應用程式也可以重新開機。</span><span class="sxs-lookup"><span data-stu-id="a10da-157">Maybe they're only used internally, and when a problem occurs, the user can contact the team responsible and the application can be restarted.</span></span> <span data-ttu-id="a10da-158">不過，客戶對於取用的應用程式通常會有更高的期望。</span><span class="sxs-lookup"><span data-stu-id="a10da-158">However, customers often have higher expectations for the applications they consume.</span></span> <span data-ttu-id="a10da-159">如果您需要知道應用程式在使用者執行之前，或在使用者通知您*之前*發生問題，您需要監視其目前狀態。</span><span class="sxs-lookup"><span data-stu-id="a10da-159">If you need to know when problems occur with your application *before* users do, or before users notify you, you need to monitor its current state.</span></span> <span data-ttu-id="a10da-160">妥善實行，監視可以讓您知道將會導致問題的狀況，讓您能夠在產生任何使用者影響之前，先解決基礎條件。</span><span class="sxs-lookup"><span data-stu-id="a10da-160">Implemented properly, monitoring can let you know about conditions that will lead to problems, letting you address underlying conditions before they result in any user impact.</span></span>

## <a name="monitoring-considerations"></a><span data-ttu-id="a10da-161">監視考慮</span><span class="sxs-lookup"><span data-stu-id="a10da-161">Monitoring considerations</span></span>

<span data-ttu-id="a10da-162">有些集中式記錄系統會以額外的角色來收集純粹記錄以外的遙測資料。</span><span class="sxs-lookup"><span data-stu-id="a10da-162">Some centralized logging systems take on an additional role of collecting telemetry outside of pure logs.</span></span> <span data-ttu-id="a10da-163">他們可以收集計量，例如執行資料庫查詢的時間、web 伺服器的平均回應時間，甚至是作業系統所報告的 CPU 負載平均和記憶體壓力。</span><span class="sxs-lookup"><span data-stu-id="a10da-163">They can collect metrics, such as time to run a database query, average response time from a web server, and even CPU load averages and memory pressure as reported by the operating system.</span></span> <span data-ttu-id="a10da-164">這些系統與記錄結合，可讓您全面瞭解系統和應用程式整體的節點健全狀況。</span><span class="sxs-lookup"><span data-stu-id="a10da-164">In conjunction with the logs, these systems can provide a holistic view of the health of nodes in the system and the application as a whole.</span></span>

<span data-ttu-id="a10da-165">監視工具的計量收集功能也可以從應用程式中手動進行。</span><span class="sxs-lookup"><span data-stu-id="a10da-165">The metric gathering capabilities of the monitoring tools can also be fed manually from within the application.</span></span> <span data-ttu-id="a10da-166">特別感興趣的商務流程，例如註冊或加入訂單的新使用者，可能會進行檢測，使其在中央監視系統中遞增計數器。</span><span class="sxs-lookup"><span data-stu-id="a10da-166">Business flows that are of particular interest such as new users signing up or orders being placed, may be instrumented such that they increment a counter in the central monitoring system.</span></span> <span data-ttu-id="a10da-167">這可將監視工具解除鎖定，而不只是監視應用程式的健康情況，也能監控企業的健全狀況。</span><span class="sxs-lookup"><span data-stu-id="a10da-167">This unlocks the monitoring tools to not only monitor the health of the application but the health of the business.</span></span>

<span data-ttu-id="a10da-168">查詢可以在記錄匯總工具中進行構建，以尋找特定的統計資料或模式，然後在自訂儀表板上以圖形形式顯示。</span><span class="sxs-lookup"><span data-stu-id="a10da-168">Queries can be constructed in the log aggregation tools to look for certain statistics or patterns, which can then be displayed in graphical form, on custom dashboards.</span></span> <span data-ttu-id="a10da-169">小組經常會投資大量的牆上裝載顯示器，以旋轉與應用程式相關的統計資料。</span><span class="sxs-lookup"><span data-stu-id="a10da-169">Frequently, teams will invest in large, wall-mounted displays that rotate through the statistics related to an application.</span></span> <span data-ttu-id="a10da-170">如此一來，在發生問題時很容易就能看到它們。</span><span class="sxs-lookup"><span data-stu-id="a10da-170">This way, it's simple to see the problems as they occur.</span></span>

## <a name="when-to-use-alerts"></a><span data-ttu-id="a10da-171">使用警示的時機</span><span class="sxs-lookup"><span data-stu-id="a10da-171">When to use alerts</span></span>

<span data-ttu-id="a10da-172">如果您需要對應用程式的問題做出反應，您需要某種方式來提醒適當的人員。</span><span class="sxs-lookup"><span data-stu-id="a10da-172">If you need to react to problems with your application, you need some way to alert the right personnel.</span></span> <span data-ttu-id="a10da-173">這是第三個雲端原生應用程式可檢視性模式，取決於記錄和監視。</span><span class="sxs-lookup"><span data-stu-id="a10da-173">This is the third cloud-native application observability pattern, and depends on logging and monitoring.</span></span> <span data-ttu-id="a10da-174">您的應用程式必須準備好進行記錄，以允許診斷問題，而在某些情況下則會饋送到監視工具。</span><span class="sxs-lookup"><span data-stu-id="a10da-174">Your application needs to have logging in place to allow problems to be diagnosed, and in some cases to feed into monitoring tools.</span></span> <span data-ttu-id="a10da-175">它需要監視，以便在一個位置匯總應用程式計量和健康情況資料。</span><span class="sxs-lookup"><span data-stu-id="a10da-175">It needs monitoring to aggregate application metrics and health data in one place.</span></span> <span data-ttu-id="a10da-176">一旦建立此規則，就可以建立可在特定計量超出可接受層級時觸發警示的規則。</span><span class="sxs-lookup"><span data-stu-id="a10da-176">Once this has been established, rules can be created that will trigger alerts when certain metrics fall outside of acceptable levels.</span></span>

## <a name="alerts"></a><span data-ttu-id="a10da-177">警示</span><span class="sxs-lookup"><span data-stu-id="a10da-177">Alerts</span></span>

<span data-ttu-id="a10da-178">您可以針對監視工具製作查詢，以尋找已知的失敗狀況。</span><span class="sxs-lookup"><span data-stu-id="a10da-178">You can craft queries against the monitoring tools to look for known failure conditions.</span></span> <span data-ttu-id="a10da-179">例如，查詢可以搜尋傳入記錄檔，以取得 HTTP 狀態碼500的指示，這表示 web 伺服器發生問題。</span><span class="sxs-lookup"><span data-stu-id="a10da-179">For instance, queries could search through the incoming logs for indications of HTTP status code 500, which indicates a problem on a web server.</span></span> <span data-ttu-id="a10da-180">一旦偵測到其中一項，就會將電子郵件或 SMS 傳送給起始服務的擁有者，而該使用者可以開始進行調查。</span><span class="sxs-lookup"><span data-stu-id="a10da-180">As soon as one of these is detected, then an e-mail or an SMS could be sent to the owner of the originating service who can begin to investigate.</span></span>

<span data-ttu-id="a10da-181">不過，單一500錯誤通常不足以判斷是否發生問題。</span><span class="sxs-lookup"><span data-stu-id="a10da-181">Typically though, a single 500 error isn't sufficient to determine that a problem has occurred.</span></span> <span data-ttu-id="a10da-182">這可能表示使用者鍵入的密碼不正確，或輸入了一些格式不正確的資料。</span><span class="sxs-lookup"><span data-stu-id="a10da-182">It could mean that a user mistyped their password or entered some malformed data.</span></span> <span data-ttu-id="a10da-183">只有在偵測到大於平均500錯誤數目的情況時，才會引發警示查詢。</span><span class="sxs-lookup"><span data-stu-id="a10da-183">The alert queries can be crafted to only fire when a larger than average number of 500 errors are detected.</span></span>

<span data-ttu-id="a10da-184">警示中最具損毀的模式之一就是引發太多警示，供人們進行調查。</span><span class="sxs-lookup"><span data-stu-id="a10da-184">One of the most damaging patterns in alerting is to fire too many alerts for humans to investigate.</span></span> <span data-ttu-id="a10da-185">服務擁有者很快就會降低了戒心先前已調查併發現良性的錯誤。</span><span class="sxs-lookup"><span data-stu-id="a10da-185">Service owners will rapidly become desensitized to errors that they've previously investigated and found to be benign.</span></span> <span data-ttu-id="a10da-186">當真正的錯誤發生時，就會在數百個誤報的雜訊中遺失。</span><span class="sxs-lookup"><span data-stu-id="a10da-186">When true errors occur then they'll be lost in the noise of hundreds of false positives.</span></span> <span data-ttu-id="a10da-187">[完成 Wolf 的男孩](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf)parable 經常會被告知孩子，以警告他們這項風險。</span><span class="sxs-lookup"><span data-stu-id="a10da-187">The parable of the [Boy Who Cried Wolf](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf) is frequently told to children to warn them of this very danger.</span></span> <span data-ttu-id="a10da-188">請務必確定引發的警示是真正的問題。</span><span class="sxs-lookup"><span data-stu-id="a10da-188">It's important to ensure that the alerts that do fire are indicative of a real problem.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="a10da-189">[上一頁](monitoring-health.md)
>[下一頁](logging-with-elastic-stack.md)</span><span class="sxs-lookup"><span data-stu-id="a10da-189">[Previous](monitoring-health.md)
[Next](logging-with-elastic-stack.md)</span></span>
