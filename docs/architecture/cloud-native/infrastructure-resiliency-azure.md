---
title: Azure 平臺復原
description: 架構適用于 Azure 的雲端原生 .NET 應用程式 |使用 Azure 的雲端基礎結構復原
ms.date: 06/30/2019
ms.openlocfilehash: 7f148588be97fa6bf8a055f5f5bed8e23908277f
ms.sourcegitcommit: 56f1d1203d0075a461a10a301459d3aa452f4f47
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2019
ms.locfileid: "71214204"
---
# <a name="azure-platform-resiliency"></a>Azure 平臺復原

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

在雲端中建立可靠的應用程式與傳統的內部部署應用程式開發不同。 雖然您在過去已購買更高階的硬體來相應增加，但在雲端環境中您會向外擴充。與其嘗試避免失敗，其目標是要將其效果降到最低，並讓系統穩定。

也就是說，可靠的雲端應用程式會顯示不同的特性：

- 它們具有彈性、可從問題中順利復原，並繼續運作。
- 它們是高可用性（HA），並以良好狀態設計，且不會有顯著的停機時間。

若要建立可靠的雲端原生應用程式，請務必瞭解這些特性如何搭配使用，以及它們如何影響成本。 接下來，我們將探討您可以利用 Azure 雲端的功能，在雲端原生應用程式中建立復原和可用性的方式。

## <a name="design-with-redundancy"></a>使用冗余設計

失敗的影響範圍會有所不同。 硬體失敗（例如失敗的磁片）可能會影響叢集中的單一節點。 失敗的網路交換器可能會影響整個伺服器機架。 較不常見的失敗（例如斷電）可能會中斷整個資料中心。 整個區域很少會變得無法使用。

[冗余](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy)是提供應用程式恢復功能的一種方式。 所需的確切冗余層級取決於您的業務需求，並會影響系統的成本和複雜度。 例如，多區域部署比單一區域部署更耗費資源，而且管理起來更複雜。 您將需要操作程式來管理容錯移轉和容錯回復。 在某些商務案例中，可能會有額外的成本和複雜度，而不是其他部分。

若要架構的冗余，您需要識別應用程式中的關鍵路徑，然後判斷路徑中的每個點是否有多餘的複本？ 如果子系統應該失敗，應用程式會故障切換到其他專案嗎？ 最後，您需要清楚瞭解 Azure 雲端平臺內建的功能，讓您可以利用它來滿足您的冗余需求。 以下是架構冗余的建議：

- *部署多個服務實例。* 如果您的應用程式相依于服務的單一實例，它會建立單一失敗點。 布建多個實例可改善復原和擴充性。 在 Azure Kubernetes Service 中裝載時，您可以在 Kubernetes 資訊清單檔中以宣告方式設定多餘的實例（複本集）。 您可以在入口網站中或透過自動調整功能（稍後會討論），以程式設計方式管理複本計數值。

- *利用負載平衡器。* 負載平衡會將應用程式的要求散發到狀況良好的服務實例，並自動從迴圈中移除狀況不良的實例。 部署至 Kubernetes 時，可以在 [服務] 區段的 Kubernetes 資訊清單檔中指定負載平衡。

- *規劃多區域部署。* 如果您的應用程式部署到單一區域，且該區域變成無法使用，您的應用程式也會變成無法使用。 這在您的應用程式服務等級協定的條款下可能無法接受。 相反地，請考慮將您的應用程式及其服務部署到多個區域。 例如，Azure Kubernetes Service （AKS）叢集會部署到單一區域。 若要保護您的系統不受區域失敗的影響，您可以將應用程式部署到不同區域的多個 AKS 叢集，並使用[配對區域](https://buildazure.com/2017/01/06/azure-region-pairs-explained/)功能來協調平臺更新並排定復原工作的優先順序。

- *啟用[異地](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication)複寫。* Azure SQL Database 和 Cosmos DB 等服務的異地複寫將會跨多個區域建立資料的次要複本。 雖然這兩個服務都會自動複寫相同區域內的資料，但異地複寫可讓您故障切換到次要區域，以防止區域性中斷。 異地複寫的另一個最佳作法是以儲存容器映射為中心。 若要在 AKS 中部署服務，您需要儲存並從存放庫提取映射。 Azure Container Registry 與 AKS 整合，而且可以安全地儲存容器映射。 若要改善效能和可用性，請考慮將映射異地複寫至您擁有 AKS 叢集的每個區域中的登錄。 每個 AKS 叢集接著會從其區域中的本機容器登錄提取容器映射，如圖6-6 所示：

![跨區域複寫的資源](./media/replicated-resources.png)

**圖 6-6**。 跨區域複寫的資源

- *執行 DNS 流量負載平衡器。* [Azure 流量管理員](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)透過在 DNS 層級的負載平衡，為重要的應用程式提供高可用性。 它可以根據地理位置、叢集回應時間，甚至是應用程式端點健全狀況，將流量路由傳送至不同的區域。 例如，Azure 流量管理員可以將客戶導向至最接近的 AKS 叢集和應用程式實例。 如果您在不同的區域中有多個 AKS 叢集，請使用流量管理員來控制流量如何流向在每個叢集中執行的應用程式。 圖6-7 顯示這種情況。

![AKS 和 Azure 流量管理員](./media/aks-traffic-manager.png)

**圖 6-7**。 AKS 和 Azure 流量管理員

## <a name="design-for-scalability"></a>擴充性設計

調整規模的雲端計畫才能生生不息。 增加/減少系統資源以解決增加/減少系統負載的能力，是 Azure 雲端的關鍵原則。 但是，若要有效地調整應用程式，您必須瞭解您在應用程式中包含的每個 Azure 服務的調整功能。  以下是在您的系統中有效執行調整的建議。

- *調整的設計。* 應用程式必須設計成可進行調整。 若要開始，服務應該是無狀態的，因此可以將要求路由傳送至任何實例。 具有無狀態服務也表示新增或移除實例並不會對目前的使用者造成不良的影響。

- *分割工作負載*。 將網域分解到獨立的獨立式微服務，可讓每個服務獨立擴充。 服務通常會有不同的擴充性需求和需求。 資料分割可讓您只調整需要調整的內容，而不需調整整個應用程式的不必要成本。

- *偏好相應放大。* 雲端式應用程式偏好向外延展資源，而非相應增加規模。 相應放大（也稱為水準調整）包含將更多服務資源新增至現有系統，以符合並共用所需的效能層級。 相應增加（也稱為垂直調整）包含以更強大的硬體（更多磁片、記憶體和處理核心）取代現有的資源。 向外延展可以使用一些 Azure 雲端資源中提供的自動調整功能來自動叫用。 跨多個資源相應放大也會增加整體系統的冗余。 最後，相應增加單一資源的成本通常比在許多較小的資源中相應放大更昂貴。 圖6-8 顯示兩種方法：

![向上擴充與相應放大](./media/scale-up-scale-out.png)

**圖6-8。** 向上擴充與相應放大

- *按星號調整。* 調整服務時，請考慮使用*資源集*。 如果您要大幅擴充特定服務，對後端資料存放區、快取和相依服務有何影響？ 有些資源（例如 Cosmos DB）可以按比例相應放大，而其他則不能。 您想要確保不會將資源向外延展到它將會耗盡其他相關資源的點。

- *避免親和性。* 最佳做法是確保節點不需要本機親和性，通常稱為「*粘滯會話*」。 要求應該能夠路由傳送至任何實例。 如果您需要保存狀態，應該將其儲存至分散式快取，例如[Azure Redis cache](https://azure.microsoft.com/services/cache/)。

- *利用平臺自動調整功能。* 盡可能使用內建的自動調整功能，而不是自訂或協力廠商機制。 可能的話，請使用排程的調整規則，以確保資源在沒有啟動延遲的情況下可供使用，但會視需要將回應自動調整新增至規則，以因應非預期的變更。 如需詳細資訊，請參閱自動調整[指引](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling)。

- *積極擴充。* 最後一種作法是積極地相應增加，讓您可以快速地滿足流量的立即尖峰，而不會失去業務。 然後，謹慎地相應減少（也就是移除不必要的資源），以避免系統穩定。 執行此作業的簡單方法是設定「冷卻」期間，也就是在調整作業之間等待的時間，這是新增資源的五分鐘，最長可達15分鐘的移除實例。

## <a name="built-in-retry-in-services"></a>服務中的內建重試

我們建議您在稍早的章節中執行程式設計重試作業的最佳作法。 請記住，許多 Azure 服務及其對應的用戶端 Sdk 也包含重試機制。 下列清單摘要說明本書中所討論的許多 Azure 服務的重試功能：

- *Azure Cosmos DB。* 來自<xref:Microsoft.Azure.Documents.Client.DocumentClient>用戶端 API 的類別會自動淘汰失敗的嘗試。 重試次數和等候時間上限是可設定的。 用戶端 API 擲回的例外狀況可能是超過重試原則或非暫時性錯誤的要求。

- *Azure Redis 快取。* Redis Stackexchange.redis 用戶端會使用連線管理員類別，其中包含嘗試失敗時的重試。 重試次數、特定的重試原則和等候時間都可設定。

- *Azure 服務匯流排。* 服務匯流排用戶端會公開一個[RetryPolicy 類別](xref:Microsoft.ServiceBus.RetryPolicy)，可使用 [輪詢間隔]、[重試計數] 和<xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer>指定作業可以採取的時間上限來設定。 預設原則是在每次嘗試之間有30秒的輪詢週期，這是九次重試次數上限。

- *Azure SQL Database。* 使用[Entity Framework Core](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency)程式庫時，會提供重試支援。

- *Azure 儲存體。* 儲存體用戶端程式庫支援重試作業。 這些策略會因 Azure 儲存體資料表、blob 和佇列而有所不同。 同樣地，當啟用異地冗余功能時，替代重試會在主要和次要儲存體服務位置之間切換。

- *Azure 事件中樞。* 事件中樞用戶端程式庫具有 RetryPolicy 屬性，其中包含可設定的指數輪詢功能。

>[!div class="step-by-step"]
>[上一頁](application-resiliency-patterns.md)
>[下一頁](resilient-communications.md)
