---
title: 微服務中的復原和高可用性
description: 微服務必須設計為能夠承受暫時性的網路和相依性失敗，他們必須能夠復原才能達到高可用性。
ms.date: 09/20/2018
ms.openlocfilehash: 6c110b0fe7a80842f12779494e5b0bdd29c5fb64
ms.sourcegitcommit: 8a0fe8a2227af612f8b8941bdb8b19d6268748e7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/03/2019
ms.locfileid: "71834344"
---
# <a name="resiliency-and-high-availability-in-microservices"></a><span data-ttu-id="237aa-103">微服務中的復原和高可用性</span><span class="sxs-lookup"><span data-stu-id="237aa-103">Resiliency and high availability in microservices</span></span>

<span data-ttu-id="237aa-104">處理未預期的失敗是最難解決的問題之一，尤其在分散式系統中。</span><span class="sxs-lookup"><span data-stu-id="237aa-104">Dealing with unexpected failures is one of the hardest problems to solve, especially in a distributed system.</span></span> <span data-ttu-id="237aa-105">開發人員撰寫的許多程式碼都是關於處理例外狀況，這也是測試時花費最多時間的部分。</span><span class="sxs-lookup"><span data-stu-id="237aa-105">Much of the code that developers write involves handling exceptions, and this is also where the most time is spent in testing.</span></span> <span data-ttu-id="237aa-106">問題比撰寫處理失敗的程式碼更為複雜。</span><span class="sxs-lookup"><span data-stu-id="237aa-106">The problem is more involved than writing code to handle failures.</span></span> <span data-ttu-id="237aa-107">當執行微服務的電腦失敗時，會發生什麼事？</span><span class="sxs-lookup"><span data-stu-id="237aa-107">What happens when the machine where the microservice is running fails?</span></span> <span data-ttu-id="237aa-108">您不僅需要偵測此微服務失敗 (其本身的難題)，還需要一些東西重新啟動您的微服務。</span><span class="sxs-lookup"><span data-stu-id="237aa-108">Not only do you need to detect this microservice failure (a hard problem on its own), but you also need something to restart your microservice.</span></span>

<span data-ttu-id="237aa-109">微服務通常需要在有可用性的另一部電腦上復原失敗以及重新啟動。</span><span class="sxs-lookup"><span data-stu-id="237aa-109">A microservice needs to be resilient to failures and to be able to restart often on another machine for availability.</span></span> <span data-ttu-id="237aa-110">此復原也會回復曾以微服務名義儲存的狀態，即微服務可以復原此狀態的來源，以及微服務是否可以成功重新啟動。</span><span class="sxs-lookup"><span data-stu-id="237aa-110">This resiliency also comes down to the state that was saved on behalf of the microservice, where the microservice can recover this state from, and whether the microservice can restart successfully.</span></span> <span data-ttu-id="237aa-111">換句話說，計算能力需要有復原功能 (程序可以隨時重新啟動)，以及狀態或資料需有復原性 (無資料遺失且資料維持一致)。</span><span class="sxs-lookup"><span data-stu-id="237aa-111">In other words, there needs to be resiliency in the compute capability (the process can restart at any time) as well as resilience in the state or data (no data loss, and the data remains consistent).</span></span>

<span data-ttu-id="237aa-112">發生其他狀況時，復原功能的問題是複合性的，例如應用程式在升級期間發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="237aa-112">The problems of resiliency are compounded during other scenarios, such as when failures occur during an application upgrade.</span></span> <span data-ttu-id="237aa-113">配合部署系統工作的微服務，需判斷要繼續前進到較新版本，還是改復原回到前一版本，以維護一致的狀態。</span><span class="sxs-lookup"><span data-stu-id="237aa-113">The microservice, working with the deployment system, needs to determine whether it can continue to move forward to the newer version or instead roll back to a previous version to maintain a consistent state.</span></span> <span data-ttu-id="237aa-114">需要考量的問題包括是否有足夠的電腦可用以繼續升級，以及如何復原舊版本的微服務等等。</span><span class="sxs-lookup"><span data-stu-id="237aa-114">Questions such as whether enough machines are available to keep moving forward and how to recover previous versions of the microservice need to be considered.</span></span> <span data-ttu-id="237aa-115">這需要微服務發出健康狀態資訊，以便全體應用程式及協調器做出決定。</span><span class="sxs-lookup"><span data-stu-id="237aa-115">This requires the microservice to emit health information so that the overall application and orchestrator can make these decisions.</span></span>

<span data-ttu-id="237aa-116">此外，復原功能與雲端式系統的必要行為方式有關。</span><span class="sxs-lookup"><span data-stu-id="237aa-116">In addition, resiliency is related to how cloud-based systems must behave.</span></span> <span data-ttu-id="237aa-117">如前所述，雲端式系統必須不怕失敗，也必須嘗試自動從失敗中復原。</span><span class="sxs-lookup"><span data-stu-id="237aa-117">As mentioned, a cloud-based system must embrace failures and must try to automatically recover from them.</span></span> <span data-ttu-id="237aa-118">例如，如果網路或容器發生錯誤，用戶端應用程式或用戶端服務必須有重試傳送訊息或重試要求的策略，因為在許多情況下，雲端的失敗僅為部分。</span><span class="sxs-lookup"><span data-stu-id="237aa-118">For instance, in case of network or container failures, client apps or client services must have a strategy to retry sending messages or to retry requests, since in many cases failures in the cloud are partial.</span></span> <span data-ttu-id="237aa-119">本指南的[實作復原應用程式](../implement-resilient-applications/index.md)一節會說明如何處理部分失敗。</span><span class="sxs-lookup"><span data-stu-id="237aa-119">The [Implementing Resilient Applications](../implement-resilient-applications/index.md) section in this guide addresses how to handle partial failure.</span></span> <span data-ttu-id="237aa-120">它描述使用類似 [Polly](https://github.com/App-vNext/Polly) 的程式庫，以 .NET Core 的指數型輪詢或斷路器模式重試等技術，提供各種處理此主體的原則。</span><span class="sxs-lookup"><span data-stu-id="237aa-120">It describes techniques like retries with exponential backoff or the Circuit Breaker pattern in .NET Core by using libraries like [Polly](https://github.com/App-vNext/Polly), which offers a large variety of policies to handle this subject.</span></span>

## <a name="health-management-and-diagnostics-in-microservices"></a><span data-ttu-id="237aa-121">微服務的健康狀態管理與診斷</span><span class="sxs-lookup"><span data-stu-id="237aa-121">Health management and diagnostics in microservices</span></span>

<span data-ttu-id="237aa-122">微服務必須報告其健康狀態及診斷，這似乎很明顯，卻常被忽略。</span><span class="sxs-lookup"><span data-stu-id="237aa-122">It may seem obvious, and it's often overlooked, but a microservice must report its health and diagnostics.</span></span> <span data-ttu-id="237aa-123">否則，作業層面的見解就會很少。</span><span class="sxs-lookup"><span data-stu-id="237aa-123">Otherwise, there's little insight from an operations perspective.</span></span> <span data-ttu-id="237aa-124">在一群獨立服務之間建立診斷事件的關聯性，以及處理電腦時鐘偏差讓事件順序有意義，困難度很高。</span><span class="sxs-lookup"><span data-stu-id="237aa-124">Correlating diagnostic events across a set of independent services and dealing with machine clock skews to make sense of the event order is challenging.</span></span> <span data-ttu-id="237aa-125">如同您透過協定之通訊協定及資料格式與微服務互動的方式，也必須設立健康狀態和診斷事件的記錄方式標準，這些事件最後都會儲存到事件存放區供查詢和檢視。</span><span class="sxs-lookup"><span data-stu-id="237aa-125">In the same way that you interact with a microservice over agreed-upon protocols and data formats, there's a need for standardization in how to log health and diagnostic events that ultimately end up in an event store for querying and viewing.</span></span> <span data-ttu-id="237aa-126">微服務方法的重點是，不同小組協定單一記錄格式。</span><span class="sxs-lookup"><span data-stu-id="237aa-126">In a microservices approach, it's key that different teams agree on a single logging format.</span></span> <span data-ttu-id="237aa-127">檢視應用程式的診斷事件需有一致的方法。</span><span class="sxs-lookup"><span data-stu-id="237aa-127">There needs to be a consistent approach to viewing diagnostic events in the application.</span></span>

### <a name="health-checks"></a><span data-ttu-id="237aa-128">健康狀態檢查</span><span class="sxs-lookup"><span data-stu-id="237aa-128">Health checks</span></span>

<span data-ttu-id="237aa-129">健康狀態與診斷不同。</span><span class="sxs-lookup"><span data-stu-id="237aa-129">Health is different from diagnostics.</span></span> <span data-ttu-id="237aa-130">健康狀態是微服務對其目前狀態採取之適當動作的報告。</span><span class="sxs-lookup"><span data-stu-id="237aa-130">Health is about the microservice reporting its current state to take appropriate actions.</span></span> <span data-ttu-id="237aa-131">使用升級與部署機制維護可用性是良好的範例。</span><span class="sxs-lookup"><span data-stu-id="237aa-131">A good example is working with upgrade and deployment mechanisms to maintain availability.</span></span> <span data-ttu-id="237aa-132">雖然服務目前可能因為處理序當機或電腦重新開機而處於不良狀態，但服務也許還能運作。</span><span class="sxs-lookup"><span data-stu-id="237aa-132">Although a service might currently be unhealthy due to a process crash or machine reboot, the service might still be operational.</span></span> <span data-ttu-id="237aa-133">您最後需要執行升級讓情況更為惡化。</span><span class="sxs-lookup"><span data-stu-id="237aa-133">The last thing you need is to make this worse by performing an upgrade.</span></span> <span data-ttu-id="237aa-134">最好的方法是先進行調查，或給微服務時間復原。</span><span class="sxs-lookup"><span data-stu-id="237aa-134">The best approach is to do an investigation first or allow time for the microservice to recover.</span></span> <span data-ttu-id="237aa-135">微服務的健康狀態事件能幫助我們做出明智的決定，並能確實幫助我們建立自我修復的服務。</span><span class="sxs-lookup"><span data-stu-id="237aa-135">Health events from a microservice help us make informed decisions and, in effect, help create self-healing services.</span></span>

<span data-ttu-id="237aa-136">在本指南的 [Implementing health checks in ASP.NET Core services](../implement-resilient-applications/monitor-app-health.md#implement-health-checks-in-aspnet-core-services) (實作 ASP.NET Core 服務中的健康狀態檢查) 一節中，我們會說明如何使用您微服務中的新 ASP.NET HealthChecks 程式庫，讓它們向監視服務報告其狀態，以採取適當的動作。</span><span class="sxs-lookup"><span data-stu-id="237aa-136">In the [Implementing health checks in ASP.NET Core services](../implement-resilient-applications/monitor-app-health.md#implement-health-checks-in-aspnet-core-services) section of this guide, we explain how to use a new ASP.NET HealthChecks library in your microservices so they can report their state to a monitoring service to take appropriate actions.</span></span>

<span data-ttu-id="237aa-137">您也可以選擇使用名為 Beat Pulse 的優異開放原始碼程式庫，可在 [GitHub](https://github.com/Xabaril/BeatPulse) 上取得，並為 [NuGet 套件](https://www.nuget.org/packages/BeatPulse/)的形式。</span><span class="sxs-lookup"><span data-stu-id="237aa-137">You also have the option of using an excellent open-source library called Beat Pulse, available on [GitHub](https://github.com/Xabaril/BeatPulse) and as a [NuGet package](https://www.nuget.org/packages/BeatPulse/).</span></span> <span data-ttu-id="237aa-138">此程式庫也會執行健康狀態檢查，但它會處理兩種檢查：</span><span class="sxs-lookup"><span data-stu-id="237aa-138">This library also does health checks, with a twist, it handles two types of checks:</span></span>

- <span data-ttu-id="237aa-139">**活躍度**：檢查微服務是否保持運作，也就是是否可以接受要求和回應。</span><span class="sxs-lookup"><span data-stu-id="237aa-139">**Liveness**: Checks if the microservice is alive, that is, if it’s able to accept requests and respond.</span></span> 
- <span data-ttu-id="237aa-140">**整備度**：檢查微服務的相依性 (資料庫、佇列服務等) 是否已就緒，以便微服務可執行應進行的作業。</span><span class="sxs-lookup"><span data-stu-id="237aa-140">**Readiness**: Checks if the microservice's dependencies (Database, queue services, etc.) are themselves ready, so the microservice can do what it’s supposed to do.</span></span> 

### <a name="using-diagnostics-and-logs-event-streams"></a><span data-ttu-id="237aa-141">使用診斷和記錄檔事件資料流</span><span class="sxs-lookup"><span data-stu-id="237aa-141">Using diagnostics and logs event streams</span></span>

<span data-ttu-id="237aa-142">記錄檔會提供應用程式或服務如何執行的資訊，包括例外狀況、警告和簡單參考訊息。</span><span class="sxs-lookup"><span data-stu-id="237aa-142">Logs provide information about how an application or service is running, including exceptions, warnings, and simple informational messages.</span></span> <span data-ttu-id="237aa-143">通常，每個記錄檔都是一行一事件的文字格式，雖然例外狀況通常也會跨多行顯示堆疊追蹤。</span><span class="sxs-lookup"><span data-stu-id="237aa-143">Usually, each log is in a text format with one line per event, although exceptions also often show the stack trace across multiple lines.</span></span>

<span data-ttu-id="237aa-144">在整合型伺服器應用程式中，您可以只將記錄寫入磁碟的檔案 (記錄檔)，再使用任何工具予以分析。</span><span class="sxs-lookup"><span data-stu-id="237aa-144">In monolithic server-based applications, you can simply write logs to a file on disk (a logfile) and then analyze it with any tool.</span></span> <span data-ttu-id="237aa-145">因為應用程式執行僅限於固定的伺服器或 VM，所以分析事件流程一般不會太複雜。</span><span class="sxs-lookup"><span data-stu-id="237aa-145">Since application execution is limited to a fixed server or VM, it generally isn't too complex to analyze the flow of events.</span></span> <span data-ttu-id="237aa-146">不過，在多項服務跨許多協調器叢集節點執行的分散式應用程式中，能夠讓分散式事件相互關聯是一項挑戰。</span><span class="sxs-lookup"><span data-stu-id="237aa-146">However, in a distributed application where multiple services are executed across many nodes in an orchestrator cluster, being able to correlate distributed events is a challenge.</span></span>

<span data-ttu-id="237aa-147">微服務型應用程式不應該嘗試自行儲存事件或記錄檔的輸出資料流，甚至不應該嘗試管理事件路由至中央位置。</span><span class="sxs-lookup"><span data-stu-id="237aa-147">A microservice-based application should not try to store the output stream of events or logfiles by itself, and not even try to manage the routing of the events to a central place.</span></span> <span data-ttu-id="237aa-148">它應該是透明的，意即每個處理序都應該只將自己的事件資料流寫入標準輸出，隨後由其執行所在之執行環境基礎結構收集。</span><span class="sxs-lookup"><span data-stu-id="237aa-148">It should be transparent, meaning that each process should just write its event stream to a standard output that underneath will be collected by the execution environment infrastructure where it's running.</span></span> <span data-ttu-id="237aa-149">這些事件資料流路由器的範例之一是 [Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow)，它會收集多個來源的事件資料流，並將它發佈至輸出系統。</span><span class="sxs-lookup"><span data-stu-id="237aa-149">An example of these event stream routers is [Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow), which collects event streams from multiple sources and publishes it to output systems.</span></span> <span data-ttu-id="237aa-150">這些包括開發環境或雲端系統的簡單標準輸出，例如 [Azure 監視器](https://azure.microsoft.com/services/monitor//)和 [Azure 診斷](https://docs.microsoft.com/azure/azure-monitor/platform/diagnostics-extension-overview)。</span><span class="sxs-lookup"><span data-stu-id="237aa-150">These can include simple standard output for a development environment or cloud systems like [Azure Monitor](https://azure.microsoft.com/services/monitor//) and [Azure Diagnostics](https://docs.microsoft.com/azure/azure-monitor/platform/diagnostics-extension-overview).</span></span> <span data-ttu-id="237aa-151">也有良好的協力廠商記錄分析平台和工具，可以搜尋、警示、報告以及監視記錄，甚至是即時的，例如 [Splunk](https://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA)。</span><span class="sxs-lookup"><span data-stu-id="237aa-151">There are also good third-party log analysis platforms and tools that can search, alert, report, and monitor logs, even in real time, like [Splunk](https://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA).</span></span>

### <a name="orchestrators-managing-health-and-diagnostics-information"></a><span data-ttu-id="237aa-152">協調器管理健康狀態和診斷資訊</span><span class="sxs-lookup"><span data-stu-id="237aa-152">Orchestrators managing health and diagnostics information</span></span>

<span data-ttu-id="237aa-153">當您建立微服務型應用程式時，您需要處理複雜性。</span><span class="sxs-lookup"><span data-stu-id="237aa-153">When you create a microservice-based application, you need to deal with complexity.</span></span> <span data-ttu-id="237aa-154">當然，單一的微服務很好處理，但是數十或數百種和成千上萬的微服務執行個體就是很複雜的問題。</span><span class="sxs-lookup"><span data-stu-id="237aa-154">Of course, a single microservice is simple to deal with, but dozens or hundreds of types and thousands of instances of microservices is a complex problem.</span></span> <span data-ttu-id="237aa-155">這不僅是建置您的微服務架構而已，如果您想要擁有穩定且一致的系統，您還需要高可用性、可定址性、復原力、健康狀態及診斷。</span><span class="sxs-lookup"><span data-stu-id="237aa-155">It isn't just about building your microservice architecture—you also need high availability, addressability, resiliency, health, and diagnostics if you intend to have a stable and cohesive system.</span></span>

![提供微服務支援平臺的叢集圖表。](./media/resilient-high-availability-microservices/microservice-platform.png)

<span data-ttu-id="237aa-157">**圖 4-22**。</span><span class="sxs-lookup"><span data-stu-id="237aa-157">**Figure 4-22**.</span></span> <span data-ttu-id="237aa-158">微服務平台是應用程式健康狀態管理的基礎</span><span class="sxs-lookup"><span data-stu-id="237aa-158">A Microservice Platform is fundamental for an application's health management</span></span>

<span data-ttu-id="237aa-159">圖 4-22 顯示的複雜問題，您很難自行解決。</span><span class="sxs-lookup"><span data-stu-id="237aa-159">The complex problems shown in Figure 4-22 are very hard to solve by yourself.</span></span> <span data-ttu-id="237aa-160">開發小組應該專注於解決商務問題以及使用微服務型方法建置自訂的應用程式。</span><span class="sxs-lookup"><span data-stu-id="237aa-160">Development teams should focus on solving business problems and building custom applications with microservice-based approaches.</span></span> <span data-ttu-id="237aa-161">他們不應該專注於解決複雜的基礎結構問題，如果他們專注於此，則所有微服務型應用程式的成本就會很龐大。</span><span class="sxs-lookup"><span data-stu-id="237aa-161">They should not focus on solving complex infrastructure problems; if they did, the cost of any microservice-based application would be huge.</span></span> <span data-ttu-id="237aa-162">因此有稱為協調器或微服務叢集的微服務導向平台，會嘗試解決建置與執行服務以及有效率使用基礎結構資源的難題。</span><span class="sxs-lookup"><span data-stu-id="237aa-162">Therefore, there are microservice-oriented platforms, referred to as orchestrators or microservice clusters, that try to solve the hard problems of building and running a service and using infrastructure resources efficiently.</span></span> <span data-ttu-id="237aa-163">這會減少使用微服務方法來建置應用程式的複雜性。</span><span class="sxs-lookup"><span data-stu-id="237aa-163">This reduces the complexities of building applications that use a microservices approach.</span></span>

<span data-ttu-id="237aa-164">不同的協調器可能看似雷同，但它們提供的診斷和健康狀態檢查在功能和到期日各不相同，有時會隨作業系統平台而異，如下節所述。</span><span class="sxs-lookup"><span data-stu-id="237aa-164">Different orchestrators might sound similar, but the diagnostics and health checks offered by each of them differ in features and state of maturity, sometimes depending on the OS platform, as explained in the next section.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="237aa-165">其他資源</span><span class="sxs-lookup"><span data-stu-id="237aa-165">Additional resources</span></span>

- <span data-ttu-id="237aa-166">**十二要素應用程式。XI.記錄檔：將記錄檔視為事件資料流** </span><span class="sxs-lookup"><span data-stu-id="237aa-166">**The Twelve-Factor App. XI. Logs: Treat logs as event streams** </span></span>\
  <https://12factor.net/logs>

- <span data-ttu-id="237aa-167">**Microsoft 診斷 EventFlow 程式庫** GitHub 存放庫</span><span class="sxs-lookup"><span data-stu-id="237aa-167">**Microsoft Diagnostic EventFlow Library** GitHub repo.</span></span> \
  <https://github.com/Azure/diagnostics-eventflow>

- <span data-ttu-id="237aa-168">**什麼是 Azure 診斷** </span><span class="sxs-lookup"><span data-stu-id="237aa-168">**What is Azure Diagnostics** </span></span>\
  <https://docs.microsoft.com/azure/azure-diagnostics>

- <span data-ttu-id="237aa-169">**將 Windows 電腦連線到 Azure 監視器服務** </span><span class="sxs-lookup"><span data-stu-id="237aa-169">**Connect Windows computers to the Azure Monitor service** </span></span>\
  <https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows>

- <span data-ttu-id="237aa-170">**記錄您的意義：使用語意記錄應用程式區塊** </span><span class="sxs-lookup"><span data-stu-id="237aa-170">**Logging What You Mean: Using the Semantic Logging Application Block** </span></span>\
  <https://docs.microsoft.com/previous-versions/msp-n-p/dn440729(v=pandp.60)>

- <span data-ttu-id="237aa-171">**Splunk** 官方網站。</span><span class="sxs-lookup"><span data-stu-id="237aa-171">**Splunk** Official site.</span></span> \
  <https://www.splunk.com/>

- <span data-ttu-id="237aa-172">Windows 事件追蹤 (ETW) **EventSource Class** API </span><span class="sxs-lookup"><span data-stu-id="237aa-172">**EventSource Class** API for events tracing for Windows (ETW) </span></span>\
  [https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource](xref:System.Diagnostics.Tracing.EventSource)

>[!div class="step-by-step"]
><span data-ttu-id="237aa-173">[上一頁](microservice-based-composite-ui-shape-layout.md)
>[下一頁](scalable-available-multi-container-microservice-applications.md)</span><span class="sxs-lookup"><span data-stu-id="237aa-173">[Previous](microservice-based-composite-ui-shape-layout.md)
[Next](scalable-available-multi-container-microservice-applications.md)</span></span>
