---
title: 在 C# 中使用預設介面成員安全地更新介面
description: 本進階教學課程探討如何安全地將新功能新增至現有的介面定義，而不會中斷實作該介面的所有類別和結構。
ms.date: 05/06/2019
ms.custom: mvc
ms.openlocfilehash: 271c737e17cc2b93424108e7e1d434fd1c7198be
ms.sourcegitcommit: 56f1d1203d0075a461a10a301459d3aa452f4f47
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2019
ms.locfileid: "71216573"
---
# <a name="tutorial-update-interfaces-with-default-interface-members-in-c-80"></a><span data-ttu-id="382d4-103">教學課程：在 C# 8.0 中使用預設介面成員更新介面</span><span class="sxs-lookup"><span data-stu-id="382d4-103">Tutorial: Update interfaces with default interface members in C# 8.0</span></span>

<span data-ttu-id="382d4-104">從 C# 8.0 開始，您可以在宣告介面成員時，於 .NET Core 3.0 上定義實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-104">Beginning with C# 8.0 on .NET Core 3.0, you can define an implementation when you declare a member of an interface.</span></span> <span data-ttu-id="382d4-105">最常見的情節是安全地將成員新增至已發行並由無數個用戶端所使用的介面。</span><span class="sxs-lookup"><span data-stu-id="382d4-105">The most common scenario is to safely add members to an interface already released and used by innumerable clients.</span></span>

<span data-ttu-id="382d4-106">在本教學課程中，您將了解如何：</span><span class="sxs-lookup"><span data-stu-id="382d4-106">In this tutorial, you'll learn how to:</span></span>

> [!div class="checklist"]
>
> * <span data-ttu-id="382d4-107">新增附實作的方法來安全地擴充介面。</span><span class="sxs-lookup"><span data-stu-id="382d4-107">Extend interfaces safely by adding methods with implementations.</span></span>
> * <span data-ttu-id="382d4-108">建立參數化實作以提高彈性。</span><span class="sxs-lookup"><span data-stu-id="382d4-108">Create parameterized implementations to provide greater flexibility.</span></span>
> * <span data-ttu-id="382d4-109">讓實作者提供覆寫形式的更特定實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-109">Enable implementers to provide a more specific implementation in the form of an override.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="382d4-110">必要條件</span><span class="sxs-lookup"><span data-stu-id="382d4-110">Prerequisites</span></span>

<span data-ttu-id="382d4-111">您必須設定電腦以執行 .NET Core，包括C# 8.0 編譯器。</span><span class="sxs-lookup"><span data-stu-id="382d4-111">You’ll need to set up your machine to run .NET Core, including the C# 8.0 compiler.</span></span> <span data-ttu-id="382d4-112">從C# [Visual Studio 2019 16.3 版](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=inline+link&utm_content=download+vs2019)或[.net Core 3.0 SDK](https://dotnet.microsoft.com/download)開始，可以使用8.0 編譯器。</span><span class="sxs-lookup"><span data-stu-id="382d4-112">The C# 8.0 compiler is available starting with [Visual Studio 2019 version 16.3](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=inline+link&utm_content=download+vs2019) or the [.NET Core 3.0 SDK](https://dotnet.microsoft.com/download).</span></span>

## <a name="scenario-overview"></a><span data-ttu-id="382d4-113">情節概觀</span><span class="sxs-lookup"><span data-stu-id="382d4-113">Scenario overview</span></span>

<span data-ttu-id="382d4-114">本教學課程從客戶關係程式庫第 1 版開始。</span><span class="sxs-lookup"><span data-stu-id="382d4-114">This tutorial starts with version 1 of a customer relationship library.</span></span> <span data-ttu-id="382d4-115">您可以在 [GitHub 的範例存放庫](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship)中取得入門應用程式。</span><span class="sxs-lookup"><span data-stu-id="382d4-115">You can get the starter application on our [samples repo on GitHub](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship).</span></span> <span data-ttu-id="382d4-116">建置此程式庫的公司想要讓客戶透過現有應用程式來採用其程式庫。</span><span class="sxs-lookup"><span data-stu-id="382d4-116">The company that built this library intended customers with existing applications to adopt their library.</span></span> <span data-ttu-id="382d4-117">他們提供可讓其程式庫使用者實作的基本介面定義。</span><span class="sxs-lookup"><span data-stu-id="382d4-117">They provided minimal interface definitions for users of their library to implement.</span></span> <span data-ttu-id="382d4-118">以下是客戶的介面定義：</span><span class="sxs-lookup"><span data-stu-id="382d4-118">Here's the interface definition for a customer:</span></span>

[!code-csharp[InitialCustomerInterface](~/samples/csharp/tutorials/default-interface-members-versions/starter/customer-relationship/ICustomer.cs?name=SnippetICustomerVersion1)]

<span data-ttu-id="382d4-119">他們定義代表訂單的第二個介面：</span><span class="sxs-lookup"><span data-stu-id="382d4-119">They defined a second interface that represents an order:</span></span>

[!code-csharp[InitialOrderInterface](~/samples/csharp/tutorials/default-interface-members-versions/starter/customer-relationship/IOrder.cs?name=SnippetIorderVersion1)]

<span data-ttu-id="382d4-120">針對這些介面，小組可以建置適用於其使用者的程式庫，來為其客戶打造更好的體驗。</span><span class="sxs-lookup"><span data-stu-id="382d4-120">From those interfaces, the team could build a library for their users to create a better experience for their customers.</span></span> <span data-ttu-id="382d4-121">其目標是加深與現有客戶的關係，並改善與新客戶的關係。</span><span class="sxs-lookup"><span data-stu-id="382d4-121">Their goal was to create a deeper relationship with existing customers and improve their relationships with new customers.</span></span>

<span data-ttu-id="382d4-122">現在，您可以將程式庫升級到下一版。</span><span class="sxs-lookup"><span data-stu-id="382d4-122">Now, it's time to upgrade the library for the next release.</span></span> <span data-ttu-id="382d4-123">其中一項所要求功能是讓擁有許多訂單的客戶享有忠誠度折扣。</span><span class="sxs-lookup"><span data-stu-id="382d4-123">One of the requested features enables a loyalty discount for customers that have lots of orders.</span></span> <span data-ttu-id="382d4-124">此新的忠誠度折扣會在每次客戶下單時套用。</span><span class="sxs-lookup"><span data-stu-id="382d4-124">This new loyalty discount gets applied whenever a customer makes an order.</span></span> <span data-ttu-id="382d4-125">此特定折扣屬於每個個別客戶。</span><span class="sxs-lookup"><span data-stu-id="382d4-125">The specific discount is a property of each individual customer.</span></span> <span data-ttu-id="382d4-126">每個的`ICustomer`執行都可以為忠誠度折扣設定不同的規則。</span><span class="sxs-lookup"><span data-stu-id="382d4-126">Each implementation of `ICustomer` can set different rules for the loyalty discount.</span></span> 

<span data-ttu-id="382d4-127">新增此功能的最自然方式，就是使用方法來增強 `ICustomer` 介面以套用任何忠誠度折扣。</span><span class="sxs-lookup"><span data-stu-id="382d4-127">The most natural way to add this functionality is to enhance the `ICustomer` interface with a method to apply any loyalty discount.</span></span> <span data-ttu-id="382d4-128">此設計建議在有經驗的開發人員之間引起顧慮：「介面一旦發行，就不可改變！</span><span class="sxs-lookup"><span data-stu-id="382d4-128">This design suggestion caused concern among experienced developers: "Interfaces are immutable once they've been released!</span></span> <span data-ttu-id="382d4-129">這是中斷性變更！」</span><span class="sxs-lookup"><span data-stu-id="382d4-129">This is a breaking change!"</span></span> <span data-ttu-id="382d4-130">C# 8.0 新增「預設介面實作」來升級介面。</span><span class="sxs-lookup"><span data-stu-id="382d4-130">C# 8.0 adds *default interface implementations* for upgrading interfaces.</span></span> <span data-ttu-id="382d4-131">程式庫作者可以將新成員新增至介面，並為這些成員提供預設實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-131">The library authors can add new members to the interface and provide a default implementation for those members.</span></span>

<span data-ttu-id="382d4-132">預設介面實作可讓開發人員升級介面，同時仍可讓任何實作者覆寫該實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-132">Default interface implementations enable developers to upgrade an interface while still enabling any implementors to override that implementation.</span></span> <span data-ttu-id="382d4-133">程式庫使用者可以接受預設實作作為非中斷性變更。</span><span class="sxs-lookup"><span data-stu-id="382d4-133">Users of the library can accept the default implementation as a non-breaking change.</span></span> <span data-ttu-id="382d4-134">如果他們的商務規則不同，則可以進行覆寫。</span><span class="sxs-lookup"><span data-stu-id="382d4-134">If their business rules are different, they can override.</span></span>

## <a name="upgrade-with-default-interface-members"></a><span data-ttu-id="382d4-135">使用預設介面成員進行升級</span><span class="sxs-lookup"><span data-stu-id="382d4-135">Upgrade with default interface members</span></span>

<span data-ttu-id="382d4-136">小組同意最有可能的預設實作，就是客戶的忠誠度折扣。</span><span class="sxs-lookup"><span data-stu-id="382d4-136">The team agreed on the most likely default implementation: a loyalty discount for customers.</span></span>

<span data-ttu-id="382d4-137">升級應該提供設定兩個屬性的功能：必須符合折扣資格的訂單數目，以及折扣百分比。</span><span class="sxs-lookup"><span data-stu-id="382d4-137">The upgrade should provide the functionality to set two properties: the number of orders needed to be eligible for the discount, and the percentage of the discount.</span></span> <span data-ttu-id="382d4-138">因此非常適合使用預設介面成員。</span><span class="sxs-lookup"><span data-stu-id="382d4-138">This makes it a perfect scenario for default interface members.</span></span> <span data-ttu-id="382d4-139">您可以將方法加入至`ICustomer`介面，並提供最可能的執行。</span><span class="sxs-lookup"><span data-stu-id="382d4-139">You can add a method to the `ICustomer` interface, and provide the most likely implementation.</span></span> <span data-ttu-id="382d4-140">所有現有及任何新的實作都可使用預設實作，或提供自己的實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-140">All existing, and any new implementations can use the default implementation, or provide their own.</span></span>

<span data-ttu-id="382d4-141">首先，將新方法新增至實作：</span><span class="sxs-lookup"><span data-stu-id="382d4-141">First, add the new method to the implementation:</span></span>

[!code-csharp[InitialOrderInterface](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetLoyaltyDiscountVersionOne)]

<span data-ttu-id="382d4-142">程式庫作者撰寫第一個測試來檢查實作：</span><span class="sxs-lookup"><span data-stu-id="382d4-142">The library author wrote a first test to check the implementation:</span></span>

[!code-csharp[TestDefaultImplementation](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetTestDefaultImplementation)]

<span data-ttu-id="382d4-143">請注意下列測試部分：</span><span class="sxs-lookup"><span data-stu-id="382d4-143">Notice the following portion of the test:</span></span>

[!code-csharp[TestDefaultImplementation](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetHighlightCast)]

<span data-ttu-id="382d4-144">`SampleCustomer` 必須轉換成 `ICustomer`。</span><span class="sxs-lookup"><span data-stu-id="382d4-144">That cast from `SampleCustomer` to `ICustomer` is necessary.</span></span> <span data-ttu-id="382d4-145">`SampleCustomer` 類別不需要提供 `ComputeLoyaltyDiscount` 的實作；這會由 `ICustomer` 介面提供。</span><span class="sxs-lookup"><span data-stu-id="382d4-145">The `SampleCustomer` class doesn't need to provide an implementation for `ComputeLoyaltyDiscount`; that's provided by the `ICustomer` interface.</span></span> <span data-ttu-id="382d4-146">不過，`SampleCustomer` 類別不會從其介面繼承成員。</span><span class="sxs-lookup"><span data-stu-id="382d4-146">However, the `SampleCustomer` class doesn't inherit members from its interfaces.</span></span> <span data-ttu-id="382d4-147">該規則並未變更。</span><span class="sxs-lookup"><span data-stu-id="382d4-147">That rule hasn't changed.</span></span> <span data-ttu-id="382d4-148">為了呼叫在介面中宣告和實作的任何方法，變數必須是介面類型，在本例中為 `ICustomer`。</span><span class="sxs-lookup"><span data-stu-id="382d4-148">In order to call any method declared and implemented in the interface, the variable must be the type of the interface, `ICustomer` in this example.</span></span>

## <a name="provide-parameterization"></a><span data-ttu-id="382d4-149">提供參數化</span><span class="sxs-lookup"><span data-stu-id="382d4-149">Provide parameterization</span></span>

<span data-ttu-id="382d4-150">這是一個不錯的起點。</span><span class="sxs-lookup"><span data-stu-id="382d4-150">That's a good start.</span></span> <span data-ttu-id="382d4-151">但預設實作太過侷限。</span><span class="sxs-lookup"><span data-stu-id="382d4-151">But, the default implementation is too restrictive.</span></span> <span data-ttu-id="382d4-152">此系統的許多取用者可能選擇不同購買數目閾值、不同成員資格長度，或不同分比折扣。</span><span class="sxs-lookup"><span data-stu-id="382d4-152">Many consumers of this system may choose different thresholds for number of purchases, a different length of membership, or a different percentage discount.</span></span> <span data-ttu-id="382d4-153">您可以藉由提供設定這些參數的方法，來為更多客戶提供更好的升級體驗。</span><span class="sxs-lookup"><span data-stu-id="382d4-153">You can provide a better upgrade experience for more customers by providing a way to set those parameters.</span></span> <span data-ttu-id="382d4-154">我們將新增靜態方法，設定這三個參數來控制預設實作：</span><span class="sxs-lookup"><span data-stu-id="382d4-154">Let's add a static method that sets those three parameters controlling the default implementation:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetLoyaltyDiscountVersionTwo)]

<span data-ttu-id="382d4-155">該小型程式碼片段中顯示許多新的語言功能。</span><span class="sxs-lookup"><span data-stu-id="382d4-155">There are many new language capabilities shown in that small code fragment.</span></span> <span data-ttu-id="382d4-156">介面現在可以包含靜態成員，包括欄位和方法。</span><span class="sxs-lookup"><span data-stu-id="382d4-156">Interfaces can now include static members, including fields and methods.</span></span> <span data-ttu-id="382d4-157">也會啟用不同的存取修飾詞。</span><span class="sxs-lookup"><span data-stu-id="382d4-157">Different access modifiers are also enabled.</span></span> <span data-ttu-id="382d4-158">其他欄位是私用的，而新方法是公用的。</span><span class="sxs-lookup"><span data-stu-id="382d4-158">The additional fields are private, the new method is public.</span></span> <span data-ttu-id="382d4-159">介面成員上允許任何修飾詞。</span><span class="sxs-lookup"><span data-stu-id="382d4-159">Any of the modifiers are allowed on interface members.</span></span>

<span data-ttu-id="382d4-160">使用一般公式來計算忠誠度折扣 (但參數不同) 的應用程式不需要提供自訂實作；這些應用程式可透過靜態方法來設定引數。</span><span class="sxs-lookup"><span data-stu-id="382d4-160">Applications that use the general formula for computing the loyalty discount, but different parameters, don't need to provide a custom implementation; they can set the arguments through a static method.</span></span> <span data-ttu-id="382d4-161">例如，下列程式碼會設定「客戶感謝」，獎勵其成員資格超過一個月的任何客戶：</span><span class="sxs-lookup"><span data-stu-id="382d4-161">For example, the following code sets a "customer appreciation" that rewards any customer with more than one month's membership:</span></span>

[!code-csharp[SetLoyaltyThresholds](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetSetLoyaltyThresholds)]

## <a name="extend-the-default-implementation"></a><span data-ttu-id="382d4-162">擴充預設實作</span><span class="sxs-lookup"><span data-stu-id="382d4-162">Extend the default implementation</span></span>

<span data-ttu-id="382d4-163">如果使用者想要類似預設實作的其他實作，或是想要提供一組不相關的規則，您到目前為止所新增程式碼為這些情節提供便利的實作。</span><span class="sxs-lookup"><span data-stu-id="382d4-163">The code you've added so far has provided a convenient implementation for those scenarios where users want something like the default implementation, or to provide an unrelated set of rules.</span></span> <span data-ttu-id="382d4-164">針對最後一項功能，我們將稍微重構程式碼，讓使用者可以在預設實作上建置。</span><span class="sxs-lookup"><span data-stu-id="382d4-164">For a final feature, let's refactor the code a bit to enable scenarios where users may want to build on the default implementation.</span></span> 

<span data-ttu-id="382d4-165">假設有間新創公司想要吸引新客戶。</span><span class="sxs-lookup"><span data-stu-id="382d4-165">Consider a startup that wants to attract new customers.</span></span> <span data-ttu-id="382d4-166">該公司提供 50% 折扣給首次下單的新客戶。</span><span class="sxs-lookup"><span data-stu-id="382d4-166">They offer a 50% discount off a new customer's first order.</span></span> <span data-ttu-id="382d4-167">至於現有的客戶則享有標準折扣。</span><span class="sxs-lookup"><span data-stu-id="382d4-167">Otherwise, existing customers get the standard discount.</span></span> <span data-ttu-id="382d4-168">程式庫作者必須將預設實作移入 `protected static` 方法，才能讓實作此介面的任何類別在其實作中重複使用程式碼。</span><span class="sxs-lookup"><span data-stu-id="382d4-168">The library author needs to move the default implementation into a `protected static` method so that any class implementing this interface can reuse the code in their implementation.</span></span> <span data-ttu-id="382d4-169">介面成員的預設實作也會呼叫此共用方法：</span><span class="sxs-lookup"><span data-stu-id="382d4-169">The default implementation of the interface member calls this shared method as well:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetFinalVersion)]

<span data-ttu-id="382d4-170">在實作此介面的類別實作中，覆寫可以呼叫靜態 Helper 方法，並擴充該邏輯以提供「新客戶」折扣：</span><span class="sxs-lookup"><span data-stu-id="382d4-170">In an implementation of a class that implements this interface, the override can call the static helper method, and extend that logic to provide the "new customer" discount:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/SampleCustomer.cs?name=SnippetOverrideAndExtend)]

<span data-ttu-id="382d4-171">您可以在 [GitHub 上的範例存放庫](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/finished/customer-relationship) \(英文\) 中查看已完成的完整程式碼。</span><span class="sxs-lookup"><span data-stu-id="382d4-171">You can see the entire finished code in our [samples repo on GitHub](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/finished/customer-relationship).</span></span> <span data-ttu-id="382d4-172">您可以在 [GitHub 的範例存放庫](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship)中取得入門應用程式。</span><span class="sxs-lookup"><span data-stu-id="382d4-172">You can get the starter application on our [samples repo on GitHub](https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship).</span></span>

<span data-ttu-id="382d4-173">這些新功能表示介面可在這些新成員有合理的預設實作時安全地更新。</span><span class="sxs-lookup"><span data-stu-id="382d4-173">These new features mean that interfaces can be updated safely when there's a reasonable default implementation for those new members.</span></span> <span data-ttu-id="382d4-174">請謹慎設計介面來表達可由多個類別實作的單一功能概念。</span><span class="sxs-lookup"><span data-stu-id="382d4-174">Carefully design interfaces to express single functional ideas that can be implemented by multiple classes.</span></span> <span data-ttu-id="382d4-175">這讓您可以在發現該相同功能概念有新需求時，更輕鬆地升級這些介面定義。</span><span class="sxs-lookup"><span data-stu-id="382d4-175">That makes it easier to upgrade those interface definitions when new requirements are discovered for that same functional idea.</span></span>
