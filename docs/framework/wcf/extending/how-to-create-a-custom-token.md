---
title: HOW TO：建立自訂權杖
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: fd168bf2e5233d9119872b267aea466a7af07041
ms.sourcegitcommit: 213292dfbb0c37d83f62709959ff55c50af5560d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/25/2018
ms.locfileid: "47170934"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="23a1b-102">HOW TO：建立自訂權杖</span><span class="sxs-lookup"><span data-stu-id="23a1b-102">How to: Create a Custom Token</span></span>
<span data-ttu-id="23a1b-103">本主題說明如何使用 <xref:System.IdentityModel.Tokens.SecurityToken> 類別來建立自訂安全性權杖，以及如何將它與自訂安全性權杖提供者和驗證器整合。</span><span class="sxs-lookup"><span data-stu-id="23a1b-103">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="23a1b-104">如需完整的程式碼範例，請參閱[自訂語彙基元](../../../../docs/framework/wcf/samples/custom-token.md)範例。</span><span class="sxs-lookup"><span data-stu-id="23a1b-104">For a complete code example see the [Custom Token](../../../../docs/framework/wcf/samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="23a1b-105">A*安全性權杖*是本質上由 Windows Communication Foundation (WCF) 安全性架構用來代表 SOAP 訊息內的寄件者的相關宣告的 XML 項目。</span><span class="sxs-lookup"><span data-stu-id="23a1b-105">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="23a1b-106">WCF 安全性系統提供的驗證模式提供各種權杖。</span><span class="sxs-lookup"><span data-stu-id="23a1b-106">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="23a1b-107">範例包括 <xref:System.IdentityModel.Tokens.X509SecurityToken> 類別所代表的 X.509 憑證安全性權杖，或是 <xref:System.IdentityModel.Tokens.UserNameSecurityToken> 類別所代表的使用者名稱安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="23a1b-107">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="23a1b-108">有時候提供的類型並不支援驗證模式或認證。</span><span class="sxs-lookup"><span data-stu-id="23a1b-108">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="23a1b-109">在此情況下，您就需要建立自訂安全性權杖，以便在 SOAP 訊息內部提供自訂認證的 XML 表示法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-109">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="23a1b-110">下列程序顯示如何建立自訂安全性權杖，以及如何將它與 WCF 安全性基礎結構整合。</span><span class="sxs-lookup"><span data-stu-id="23a1b-110">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="23a1b-111">本主題將建立信用卡權杖，它可以用來將用戶端的信用卡相關資訊傳遞給伺服器。</span><span class="sxs-lookup"><span data-stu-id="23a1b-111">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="23a1b-112">如需有關自訂認證和安全性權杖管理員的詳細資訊，請參閱 <<c0> [ 逐步解說： 建立自訂用戶端和服務認證](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-112">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="23a1b-113">如需其他代表安全性權杖的類別，請參閱 <xref:System.IdentityModel.Tokens> 命名空間。</span><span class="sxs-lookup"><span data-stu-id="23a1b-113">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
 <span data-ttu-id="23a1b-114">如需有關認證、 安全性權杖管理員，以及提供者和驗證器類別的詳細資訊，請參閱 <<c0> [ 安全性架構](https://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-114">For more information about credentials, security token manager, and provider and authenticator classes, see [Security Architecture](https://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f).</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="23a1b-115">程序</span><span class="sxs-lookup"><span data-stu-id="23a1b-115">Procedures</span></span>  
 <span data-ttu-id="23a1b-116">您必須提供用戶端應用程式為安全性基礎結構指定信用卡資訊的方式，</span><span class="sxs-lookup"><span data-stu-id="23a1b-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="23a1b-117">此資訊可由自訂用戶端認證類別提供給應用程式使用。</span><span class="sxs-lookup"><span data-stu-id="23a1b-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="23a1b-118">第一步就是為自訂用戶端認證建立代表信用卡資訊的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="23a1b-119">若要在用戶端認證內部建立代表信用卡資訊的類別</span><span class="sxs-lookup"><span data-stu-id="23a1b-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1.  <span data-ttu-id="23a1b-120">為應用程式定義代表信用卡資訊的新類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="23a1b-121">下列範例將類別命名為 `CreditCardInfo`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2.  <span data-ttu-id="23a1b-122">將適當的屬性加入至類別，讓應用程式能夠設定自訂權杖所需的必要資訊。</span><span class="sxs-lookup"><span data-stu-id="23a1b-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="23a1b-123">在此範例中，類別具有三種屬性：`CardNumber`、`CardIssuer` 和 `ExpirationDate`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="23a1b-124">接下來，必須建立可代表自訂安全性權杖的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="23a1b-125">這個類別的安全性權杖提供者、 驗證程式和序列化程式類別來傳遞安全性權杖與 WCF 安全性基礎結構的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="23a1b-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="23a1b-126">若要建立自訂安全性權杖類別</span><span class="sxs-lookup"><span data-stu-id="23a1b-126">To create a custom security token class</span></span>  
  
1.  <span data-ttu-id="23a1b-127">定義衍生自 <xref:System.IdentityModel.Tokens.SecurityToken> 類別的新類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="23a1b-128">本範例會建立名為 `CreditCardToken` 的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2.  <span data-ttu-id="23a1b-129">覆寫 <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="23a1b-130">這個屬性是用來取得安全性權杖的區域識別項，該識別項則是用來指向 SOAP 訊息內來自其他項目的安全性權杖 XML 表示法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="23a1b-131">在此範例中，可以將權杖識別項當成建構函式參數傳遞給它，否則每次建立安全性權杖執行個體時，就會產生新的隨機權杖識別項。</span><span class="sxs-lookup"><span data-stu-id="23a1b-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3.  <span data-ttu-id="23a1b-132">實作 <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="23a1b-133">此屬性會傳回安全性權杖執行個體所代表的安全性金鑰集合。</span><span class="sxs-lookup"><span data-stu-id="23a1b-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="23a1b-134">WCF 可以使用這類金鑰來簽署或加密部分 SOAP 訊息。</span><span class="sxs-lookup"><span data-stu-id="23a1b-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="23a1b-135">在此範例中，信用卡安全性權杖無法包含任何安全性金鑰；因此，實作一律會傳回空的集合。</span><span class="sxs-lookup"><span data-stu-id="23a1b-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4.  <span data-ttu-id="23a1b-136">覆寫 <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> 和 <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="23a1b-137">這些屬性可由 WCF 決定安全性權杖執行個體的有效性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="23a1b-138">在此範例中，信用卡安全性權杖只擁有一個到期日，因此 `ValidFrom` 屬性會傳回 <xref:System.DateTime>，這個值代表執行個體的建立日期與時間。</span><span class="sxs-lookup"><span data-stu-id="23a1b-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="23a1b-139">新的安全性權杖類型建立完畢後，需要實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> 類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="23a1b-140">這項實作會在安全性繫結項目組態中用來代表新的權杖類型。</span><span class="sxs-lookup"><span data-stu-id="23a1b-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="23a1b-141">安全性權杖參數類別可當成範本，用來比對實際安全性權杖執行個體與訊息處理時間。</span><span class="sxs-lookup"><span data-stu-id="23a1b-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="23a1b-142">範本所提供的其他屬性可供應用程式用來指定準則，安全性權杖必須符合這個準則才能加以使用或驗證。</span><span class="sxs-lookup"><span data-stu-id="23a1b-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="23a1b-143">下列範例不會新增任何額外的屬性，因此只會比對時，WCF 基礎結構搜尋安全性權杖執行個體使用，或驗證的語彙基元型別安全性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="23a1b-144">若要建立自訂安全性權杖參數類別</span><span class="sxs-lookup"><span data-stu-id="23a1b-144">To create a custom security token parameters class</span></span>  
  
1.  <span data-ttu-id="23a1b-145">定義衍生自 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> 類別的新類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2.  <span data-ttu-id="23a1b-146">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="23a1b-147">複製類別中已定義的所有內部欄位 (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="23a1b-148">此範例並未定義任何其他欄位。</span><span class="sxs-lookup"><span data-stu-id="23a1b-148">This example does not define any additional fields.</span></span>  
  
3.  <span data-ttu-id="23a1b-149">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> 唯讀屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="23a1b-150">如果此類別所代表的安全性權杖類型可用來驗證服務的用戶端，則這個屬性會傳回 `true`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="23a1b-151">在此範例中，信用卡安全性權杖可用來驗證服務的用戶端。</span><span class="sxs-lookup"><span data-stu-id="23a1b-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4.  <span data-ttu-id="23a1b-152">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> 唯讀屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="23a1b-153">如果此類別所代表的安全性權杖類型可用來驗證用戶端服務，則這個屬性會傳回 `true`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="23a1b-154">在此範例中，信用卡安全性權杖不可用來驗證用戶端服務。</span><span class="sxs-lookup"><span data-stu-id="23a1b-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5.  <span data-ttu-id="23a1b-155">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> 唯讀屬性。</span><span class="sxs-lookup"><span data-stu-id="23a1b-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="23a1b-156">如果此類別所代表的安全性權杖類型可用來對應至 Windows 帳戶，則這個屬性會傳回 `true`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="23a1b-157">因此，驗證結果會由 <xref:System.Security.Principal.WindowsIdentity> 類別執行個體來表示。</span><span class="sxs-lookup"><span data-stu-id="23a1b-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="23a1b-158">在此範例中，權杖無法對應至 Windows 帳戶。</span><span class="sxs-lookup"><span data-stu-id="23a1b-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6.  <span data-ttu-id="23a1b-159">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="23a1b-160">如果需要此安全性權杖參數類別所代表的安全性權杖執行個體的參考，則 WCF 安全性架構會呼叫這個方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="23a1b-161">實際安全性權杖執行個體與可指定所要求之參考型別的 <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> 會同時當成引數傳遞至此方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="23a1b-162">在此範例中，信用卡安全性權杖僅支援內部參考。</span><span class="sxs-lookup"><span data-stu-id="23a1b-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="23a1b-163"><xref:System.IdentityModel.Tokens.SecurityToken> 類別具有建立內部參考的功能，因此實作不需要其他程式碼。</span><span class="sxs-lookup"><span data-stu-id="23a1b-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7.  <span data-ttu-id="23a1b-164">實作 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="23a1b-165">會呼叫這個方法，將安全性權杖參數類別執行個體轉換成的執行個體的 wcf<xref:System.IdentityModel.Selectors.SecurityTokenRequirement>類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="23a1b-166">安全性權杖提供者會使用此結果來建立適當的安全性權杖執行個體。</span><span class="sxs-lookup"><span data-stu-id="23a1b-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="23a1b-167">安全性權杖會在 SOAP 訊息內傳輸，這麼做需要在記憶體中的安全性權杖表示與網路上的表示之間使用轉譯機制。</span><span class="sxs-lookup"><span data-stu-id="23a1b-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="23a1b-168">WCF 會使用安全性權杖序列化程式來完成這項工作。</span><span class="sxs-lookup"><span data-stu-id="23a1b-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="23a1b-169">每個自訂權杖必須搭配自訂安全性權杖序列化程式，這個程式可以序列化與還原序列化來自 SOAP 訊息的自訂安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="23a1b-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="23a1b-170">衍生金鑰預設為啟用。</span><span class="sxs-lookup"><span data-stu-id="23a1b-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="23a1b-171">如果您建立自訂安全性權杖，並使用它當做主要權杖時，WCF 會從它衍生金鑰。</span><span class="sxs-lookup"><span data-stu-id="23a1b-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="23a1b-172">這時，它會呼叫自訂安全性權杖序列化程式來寫入自訂安全性權杖的 <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause>，同時將 `DerivedKeyToken` 序列化至連線。</span><span class="sxs-lookup"><span data-stu-id="23a1b-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="23a1b-173">在接收端，將連線上的權杖還原序列化時，`DerivedKeyToken` 序列化程式需要 `SecurityTokenReference` 項目做為它底下的最上層子項目。</span><span class="sxs-lookup"><span data-stu-id="23a1b-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="23a1b-174">如果自訂安全性權杖序列化程式在序列化其子句型別時未加入 `SecurityTokenReference` 項目，則會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="23a1b-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="23a1b-175">若要建立自訂安全性權杖序列化程式</span><span class="sxs-lookup"><span data-stu-id="23a1b-175">To create a custom security token serializer</span></span>  
  
1.  <span data-ttu-id="23a1b-176">定義衍生自 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> 類別的新類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2.  <span data-ttu-id="23a1b-177">覆寫 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> 方法，這個方法需要靠 <xref:System.Xml.XmlReader> 讀取 XML 串流。</span><span class="sxs-lookup"><span data-stu-id="23a1b-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="23a1b-178">如果序列化程式實作可以根據目前指定的項目來還原序列化安全性權杖，則方法會傳回 `true`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="23a1b-179">在此範例中，此方法會檢查 XML 讀取器目前的 XML 項目是否具備正確的項目名稱與命名空間。</span><span class="sxs-lookup"><span data-stu-id="23a1b-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="23a1b-180">如果不具備的話，它會呼叫此方法的基底類別實作來處理 XML 項目。</span><span class="sxs-lookup"><span data-stu-id="23a1b-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3.  <span data-ttu-id="23a1b-181">覆寫 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="23a1b-182">此方法會讀取安全性權杖的 XML 內容，並且為權杖建構適當的記憶體內部表示法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="23a1b-183">如果它無法辨識傳入之 XML 讀取器所在的 XML 項目，則會呼叫基底類別實作來處理系統提供的權杖類型。</span><span class="sxs-lookup"><span data-stu-id="23a1b-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4.  <span data-ttu-id="23a1b-184">覆寫 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="23a1b-185">如果此方法可將記憶體內部的權杖表示法 (當成引數傳入) 轉換為 XML 表示法，則會傳回 `true`。</span><span class="sxs-lookup"><span data-stu-id="23a1b-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="23a1b-186">如果無法轉換，則會呼叫基底類別實作。</span><span class="sxs-lookup"><span data-stu-id="23a1b-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5.  <span data-ttu-id="23a1b-187">覆寫 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="23a1b-188">此方法會將記憶體內部的安全性權杖表示法轉換為 XML 表示法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="23a1b-189">如果無法轉換，則會呼叫基底類別實作。</span><span class="sxs-lookup"><span data-stu-id="23a1b-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="23a1b-190">在完成上述四個程序之後，請將自訂安全性權杖與安全性權杖提供者、驗證器、管理員，以及用戶端與服務認證，全部整合在一起。</span><span class="sxs-lookup"><span data-stu-id="23a1b-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="23a1b-191">若要將自訂安全性權杖與安全性權杖提供者整合</span><span class="sxs-lookup"><span data-stu-id="23a1b-191">To integrate the custom security token with a security token provider</span></span>  
  
1.  <span data-ttu-id="23a1b-192">安全性權杖提供者會建立、修改 (視需要) 和傳回權杖的執行個體。</span><span class="sxs-lookup"><span data-stu-id="23a1b-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="23a1b-193">若要建立自訂安全性權杖的自訂提供者，請建立繼承自 <xref:System.IdentityModel.Selectors.SecurityTokenProvider> 類別的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="23a1b-194">下列範例會覆寫 <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> 方法以傳回 `CreditCardToken` 的執行個體。</span><span class="sxs-lookup"><span data-stu-id="23a1b-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="23a1b-195">如需有關自訂安全性權杖提供者的詳細資訊，請參閱 <<c0> [ 如何： 建立自訂安全性權杖提供者](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="23a1b-196">若要將自訂安全性權杖與安全性權杖驗證器整合</span><span class="sxs-lookup"><span data-stu-id="23a1b-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1.  <span data-ttu-id="23a1b-197">當安全性權杖從訊息中擷取出來時，安全性權杖驗證器會驗證其內容。</span><span class="sxs-lookup"><span data-stu-id="23a1b-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="23a1b-198">若要建立自訂安全性權杖的自訂驗證器，請建立繼承自 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> 類別的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="23a1b-199">下列範例會覆寫 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="23a1b-200">如需有關自訂安全性權杖驗證器的詳細資訊，請參閱 <<c0> [ 如何： 建立自訂安全性權杖驗證器](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="23a1b-201">若要將自訂安全性權杖與安全性權杖管理員整合</span><span class="sxs-lookup"><span data-stu-id="23a1b-201">To integrate the custom security token with a security token manager</span></span>  
  
1.  <span data-ttu-id="23a1b-202">安全性權杖管理員會建立適當的權杖提供者、安全性驗證器，以及權杖序列化程式執行個體。</span><span class="sxs-lookup"><span data-stu-id="23a1b-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="23a1b-203">若要建立自訂的權杖管理員，請建立繼承自 <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> 類別的類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="23a1b-204">該類別的主要方法會使用 <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> 來建立適當的提供者與用戶端或服務認證。</span><span class="sxs-lookup"><span data-stu-id="23a1b-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="23a1b-205">如需有關自訂安全性權杖管理員的詳細資訊，請參閱 <<c0> [ 逐步解說： 建立自訂用戶端和服務認證](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="23a1b-206">若要將自訂安全性權杖與自訂用戶端及服務認證整合</span><span class="sxs-lookup"><span data-stu-id="23a1b-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1.  <span data-ttu-id="23a1b-207">您必須新增自訂的用戶端及服務認證才能提供應用程式的 API，以便指定自訂權杖資訊，而先前建立的自訂安全性權杖基礎結構會使用這項資訊來提供並驗證自訂安全性權杖內容。</span><span class="sxs-lookup"><span data-stu-id="23a1b-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="23a1b-208">下列範例會示範執行此作業的方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-208">The following samples show how this can be done.</span></span> <span data-ttu-id="23a1b-209">如需有關自訂用戶端和服務認證的詳細資訊，請參閱 <<c0> [ 逐步解說： 建立自訂用戶端和服務認證](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="23a1b-210">先前建立的自訂安全性權杖參數類別用來告知 WCF 安全性架構與服務通訊時，必須使用自訂安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="23a1b-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="23a1b-211">下列程序會示範執行此作業的方法。</span><span class="sxs-lookup"><span data-stu-id="23a1b-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="23a1b-212">若要將自訂安全性權杖與繫結整合</span><span class="sxs-lookup"><span data-stu-id="23a1b-212">To integrate the custom security token with the binding</span></span>  
  
1.  <span data-ttu-id="23a1b-213">您必須在 <xref:System.ServiceModel.Channels.SecurityBindingElement> 類別上公開的其中一個權杖參數集合指定自訂安全性權杖參數類別。</span><span class="sxs-lookup"><span data-stu-id="23a1b-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="23a1b-214">下列範例會使用 `SignedEncrypted` 所傳回的集合。</span><span class="sxs-lookup"><span data-stu-id="23a1b-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="23a1b-215">程式碼會將信用卡自訂權杖新增至每個從服務用戶端傳送的訊息，並且自動簽署並加密其內容。</span><span class="sxs-lookup"><span data-stu-id="23a1b-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="23a1b-216">本主題顯示實作和使用自訂權杖所需的各種程式碼。</span><span class="sxs-lookup"><span data-stu-id="23a1b-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="23a1b-217">若要查看完整的範例方式的所有這些程式碼拼湊在一起，請參閱 <<c0> [ 自訂語彙基元](../../../../docs/framework/wcf/samples/custom-token.md)。</span><span class="sxs-lookup"><span data-stu-id="23a1b-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../../../../docs/framework/wcf/samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="23a1b-218">另請參閱</span><span class="sxs-lookup"><span data-stu-id="23a1b-218">See Also</span></span>  
 <xref:System.IdentityModel.Tokens.SecurityToken>  
 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>  
 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>  
 <xref:System.IdentityModel.Selectors.SecurityTokenProvider>  
 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>  
 <xref:System.IdentityModel.Policy.IAuthorizationPolicy>  
 <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>  
 <xref:System.IdentityModel.Selectors.SecurityTokenManager>  
 <xref:System.ServiceModel.Description.ClientCredentials>  
 <xref:System.ServiceModel.Description.ServiceCredentials>  
 <xref:System.ServiceModel.Channels.SecurityBindingElement>  
 [<span data-ttu-id="23a1b-219">逐步解說：建立自訂用戶端和服務認證</span><span class="sxs-lookup"><span data-stu-id="23a1b-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)  
 [<span data-ttu-id="23a1b-220">如何：建立自訂安全性權杖驗證器</span><span class="sxs-lookup"><span data-stu-id="23a1b-220">How to: Create a Custom Security Token Authenticator</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md)  
 [<span data-ttu-id="23a1b-221">如何：建立自訂安全性權杖提供者</span><span class="sxs-lookup"><span data-stu-id="23a1b-221">How to: Create a Custom Security Token Provider</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)  
 [<span data-ttu-id="23a1b-222">安全性架構</span><span class="sxs-lookup"><span data-stu-id="23a1b-222">Security Architecture</span></span>](https://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f)
