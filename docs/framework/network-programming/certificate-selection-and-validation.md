---
title: "憑證的選取和驗證"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: c933aca2-4cd0-4ff1-9df9-267143f25a6f
caps.latest.revision: "15"
author: mcleblanc
ms.author: markl
manager: markl
ms.workload: dotnet
ms.openlocfilehash: 54d1409b74793a8539f432ce0b43f410d578e934
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/22/2017
---
# <a name="certificate-selection-and-validation"></a><span data-ttu-id="b5c9b-102">憑證的選取和驗證</span><span class="sxs-lookup"><span data-stu-id="b5c9b-102">Certificate Selection and Validation</span></span>
<span data-ttu-id="b5c9b-103"><xref:System.Net> 類別支援數種方式來選取並驗證 <xref:System.Security.Cryptography.X509Certificates>，以進行安全通訊端層 (SSL) 連線。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-103">The <xref:System.Net> classes support several ways to select and validate <xref:System.Security.Cryptography.X509Certificates> for Secure Socket Layer (SSL) connections.</span></span> <span data-ttu-id="b5c9b-104">用戶端可以選取一或多個憑證，以向伺服器驗證它自己。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-104">A client can select one or more certificates to authenticate itself to a server.</span></span> <span data-ttu-id="b5c9b-105">伺服器可能需要用戶端憑證具有一或多個特定屬性，來進行驗證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-105">A server can require that a client certificate have one or more specific attributes for authentication.</span></span>  
  
## <a name="definition"></a><span data-ttu-id="b5c9b-106">定義</span><span class="sxs-lookup"><span data-stu-id="b5c9b-106">Definition</span></span>  
 <span data-ttu-id="b5c9b-107">憑證是一個 ASCII 位元組資料流，包含公開金鑰、屬性 (例如版本號碼、序號和到期日) 以及來自憑證授權單位的數位簽章。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-107">A certificate is an ASCII byte stream that contains a public key, attributes (such as version number, serial number, and expiration date) and a digital signature from a Certificate Authority.</span></span> <span data-ttu-id="b5c9b-108">憑證是用來建立加密連線，或向伺服器驗證用戶端。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-108">Certificates are used to establish an encrypted connection or to authenticate a client to a server.</span></span>  
  
## <a name="client-certificate-selection-and-validation"></a><span data-ttu-id="b5c9b-109">用戶端憑證選取和驗證</span><span class="sxs-lookup"><span data-stu-id="b5c9b-109">Client Certificate Selection and Validation</span></span>  
 <span data-ttu-id="b5c9b-110">用戶端可以選取特定 SSL 連線的一或多個憑證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-110">A client can select one or more certificates for a specific SSL connection.</span></span> <span data-ttu-id="b5c9b-111">用戶端憑證可以與網頁伺服器或 SMTP 郵件伺服器的 SSL 連線建立關聯。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-111">Client certificates can be associated with the SSL connection to a web server or an SMTP mail server.</span></span> <span data-ttu-id="b5c9b-112">用戶端會將憑證新增至 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 或 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 類別物件集合。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-112">A client adds certificates to a collection of <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects.</span></span> <span data-ttu-id="b5c9b-113">使用電子郵件作為範例，憑證集合是與 <xref:System.Net.Mail.SmtpClient> 類別之 <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> 屬性建立關聯的 <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection> 執行個體。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-113">Using email as an example, the certificate collection is an instance of a <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection>) associated with the <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> property of the <xref:System.Net.Mail.SmtpClient> class.</span></span> <span data-ttu-id="b5c9b-114"><xref:System.Net.HttpWebRequest> 類別具有類似的 <xref:System.Net.HttpWebRequest.ClientCertificates%2A> 屬性。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-114">The <xref:System.Net.HttpWebRequest> class has a similar <xref:System.Net.HttpWebRequest.ClientCertificates%2A> property.</span></span>  
  
 <span data-ttu-id="b5c9b-115"><xref:System.Security.Cryptography.X509Certificates.X509Certificate> 與 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 類別之間的主要差異，在於私密金鑰必須位在 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 類別的憑證存放區中。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-115">The primary difference between the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class is that the private key must reside in the certificate store for the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> class.</span></span>  
  
 <span data-ttu-id="b5c9b-116">即使將憑證新增至集合，並與特定 SSL 連線建立關聯，也不會將任何憑證傳送至伺服器，除非伺服器要求它們。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-116">Even if certificates are added to a collection and associated with a specific SSL connection, no certificates will be sent to the server unless the server requests them.</span></span> <span data-ttu-id="b5c9b-117">如果在連線上設定多個用戶端憑證，將會根據演算法來使用最佳用戶端憑證，而演算法考慮伺服器所提供的憑證簽發者清單與用戶端憑證簽發者名稱之間的相符項目。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-117">If multiple client certificates are set on a connection, the best one will be used based on an algorithm that considers the match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span>  
  
 <span data-ttu-id="b5c9b-118"><xref:System.Net.Security.SslStream> 類別甚至可更進一步控制 SSL 交握。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-118">The <xref:System.Net.Security.SslStream> class provides even more control over the SSL handshake.</span></span> <span data-ttu-id="b5c9b-119">用戶端可以指定委派，以挑選要使用的用戶端憑證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-119">A client can specify a delegate to pick which client certificate to use.</span></span>  
  
 <span data-ttu-id="b5c9b-120">遠端伺服器可以確認用戶端憑證有效、最新並且是由適當的憑證授權單位所簽署。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-120">A remote server can verify that a client certificate is valid, current, and signed by the appropriate Certificate Authority.</span></span> <span data-ttu-id="b5c9b-121">委派可以新增至 <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A>，以強制執行憑證驗證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-121">A delegate can be added to the <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> to enforce certificate validation.</span></span>  
  
## <a name="client-certificate-selection"></a><span data-ttu-id="b5c9b-122">用戶端憑證選擇</span><span class="sxs-lookup"><span data-stu-id="b5c9b-122">Client Certificate Selection</span></span>  
 <span data-ttu-id="b5c9b-123">.NET Framework 使用下列方式選取要向伺服器呈現的用戶端憑證：</span><span class="sxs-lookup"><span data-stu-id="b5c9b-123">The .NET Framework selects the client certificate to present to the server in the following manner:</span></span>  
  
1.  <span data-ttu-id="b5c9b-124">如果先前向伺服器呈現用戶端憑證，則會在第一次呈現時快取憑證，並重複用於後續的用戶端憑證要求。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-124">If a client certificate was presented previously to the server, the certificate is cached when first presented and is reused for subsequent client certificate requests.</span></span>  
  
2.  <span data-ttu-id="b5c9b-125">如果具有委派，請一律使用委派結果作為可選取的用戶端憑證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-125">If a delegate is present, always use the result from the delegate as the client certificate to select.</span></span> <span data-ttu-id="b5c9b-126">可能的話，請嘗試使用快取的憑證；但是，如果委派已傳回 Null，而且憑證集合不是空的，則不會使用快取的匿名認證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-126">Try to use a cached certificate when possible, but do not use cached anonymous credentials if the delegate has returned null and the certificate collection is not empty.</span></span>  
  
3.  <span data-ttu-id="b5c9b-127">如果這是用戶端憑證的第一個挑戰，Framework 會列舉與連線建立關聯之 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 或 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 類別物件中的憑證，以尋找伺服器所提供的憑證簽發者清單與用戶端憑證簽發者名稱之間的相符項目。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-127">If this is the first challenge for a client certificate, the Framework enumerates the certificates in <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span> <span data-ttu-id="b5c9b-128">第一個符合的憑證會傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-128">The first certificate that matches is sent to the server.</span></span> <span data-ttu-id="b5c9b-129">如果沒有相符的憑證，或憑證集合是空的，則會將匿名認證傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-129">If no certificate matches or the certificate collection is empty, then an anonymous credential is sent to the server.</span></span>  
  
## <a name="tools-for-certificate-configuration"></a><span data-ttu-id="b5c9b-130">憑證組態的工具</span><span class="sxs-lookup"><span data-stu-id="b5c9b-130">Tools for Certificate Configuration</span></span>  
 <span data-ttu-id="b5c9b-131">數個工具可進行用戶端和伺服器憑證組態。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-131">A number of tools are available for client and server certificate configuration.</span></span>  
  
 <span data-ttu-id="b5c9b-132">*Winhttpcertcfg.exe* 工具可以用來設定用戶端憑證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-132">The *Winhttpcertcfg.exe* tool can be used to configure client certificates.</span></span> <span data-ttu-id="b5c9b-133">*Winhttpcertcfg.exe* 工具隨附為 Windows Server 2003 Resource Kit 的其中一個工具。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-133">The *Winhttpcertcfg.exe* tool is provided as one of the tools with the Windows Server 2003 Resource Kit.</span></span> <span data-ttu-id="b5c9b-134">您可以在 www.microsoft.com 下載此工具，作為 Windows Server 2003 Resource Kit Tools 的一部分。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-134">This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at www.microsoft.com.</span></span>  
  
 <span data-ttu-id="b5c9b-135">*HttpCfg.exe* 工具可以用來設定 <xref:System.Net.HttpListener> 類別的伺服器憑證。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-135">*The HttpCfg.exe* tool can be used to configure server certificates for the <xref:System.Net.HttpListener> class.</span></span> <span data-ttu-id="b5c9b-136">*HttpCfg.exe* 工具隨附為 Windows Server 2003 和 Windows XP Service Pack 2 的其中一個支援工具。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-136">The *HttpCfg.exe* tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2.</span></span> <span data-ttu-id="b5c9b-137">在 Windows Server 2003 或 Windows XP 上，預設不會安裝 *HttpCfg.exe* 和其他支援工具。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-137">*HttpCfg.exe* and the other support tools are not installed by default on either Windows Server 2003 or Windows XP.</span></span> <span data-ttu-id="b5c9b-138">在 Windows Server 2003 上。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-138">On Windows Server 2003.</span></span> <span data-ttu-id="b5c9b-139">從 Windows Server 2003 CD-ROM 的下列資料夾和檔案中個別安裝支援工具：</span><span class="sxs-lookup"><span data-stu-id="b5c9b-139">the support tools are installed separately from the following folder and file on the Windows Server 2003 CD-ROM:</span></span>  
  
 <span data-ttu-id="b5c9b-140">\Support\Tools\Suptools.msi</span><span class="sxs-lookup"><span data-stu-id="b5c9b-140">\Support\Tools\Suptools.msi</span></span>  
  
 <span data-ttu-id="b5c9b-141">若要與 Windows XP Service Pack 2 搭配使用，您可以從 www.microsoft.com 下載 Windows XP 支援工具。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-141">For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from www.microsoft.com.</span></span>  
  
 <span data-ttu-id="b5c9b-142">*HttpCfg.exe* 工具版本的原始程式碼也會提供為 Windows Server SDK 的範例。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-142">The source code to a version of the *HttpCfg.exe* tool is also provided as a sample with the Windows Server SDK.</span></span> <span data-ttu-id="b5c9b-143">在下列資料夾下，*HttpCfg.exe* 範例的原始程式碼預設會與網路範例一起安裝為 Windows SDK 的一部分：</span><span class="sxs-lookup"><span data-stu-id="b5c9b-143">The source code to the *HttpCfg.exe* sample is installed by default with the networking samples as part of the Windows SDK under the following folder:</span></span>  
  
 <span data-ttu-id="b5c9b-144">*C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig*</span><span class="sxs-lookup"><span data-stu-id="b5c9b-144">*C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig*</span></span>  
  
 <span data-ttu-id="b5c9b-145">除了這些工具之外，<xref:System.Security.Cryptography.X509Certificates.X509Certificate> 和 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 類別還會提供從檔案系統載入憑證的方法。</span><span class="sxs-lookup"><span data-stu-id="b5c9b-145">In addition to these tools, the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> classes provides methods for loading a certificate from the file system.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b5c9b-146">請參閱</span><span class="sxs-lookup"><span data-stu-id="b5c9b-146">See Also</span></span>  
 [<span data-ttu-id="b5c9b-147">網路程式設計的安全性</span><span class="sxs-lookup"><span data-stu-id="b5c9b-147">Security in Network Programming</span></span>](../../../docs/framework/network-programming/security-in-network-programming.md)  
 [<span data-ttu-id="b5c9b-148">以 .NET Framework 進行網路程式設計</span><span class="sxs-lookup"><span data-stu-id="b5c9b-148">Network Programming in the .NET Framework</span></span>](../../../docs/framework/network-programming/index.md)
