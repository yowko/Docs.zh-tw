---
title: 使用 IPv6 和 Teredo 的 NAT 周遊
ms.date: 03/30/2017
ms.assetid: 568cd245-3300-49ef-a995-d81bf845d961
ms.openlocfilehash: 32f3caa88e05c7261d5cb7646ac618d33ca1e060
ms.sourcegitcommit: c93fd5139f9efcf6db514e3474301738a6d1d649
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/27/2018
ms.locfileid: "50185452"
---
# <a name="nat-traversal-using-ipv6-and-teredo"></a><span data-ttu-id="ca654-102">使用 IPv6 和 Teredo 的 NAT 周遊</span><span class="sxs-lookup"><span data-stu-id="ca654-102">NAT Traversal using IPv6 and Teredo</span></span>
<span data-ttu-id="ca654-103">已進行支援網路位址轉譯 (NAT) 周遊的增強功能。</span><span class="sxs-lookup"><span data-stu-id="ca654-103">Enhancements were made that provide support for Network Address Translation (NAT) traversal.</span></span> <span data-ttu-id="ca654-104">這些變更設計成與 IPv6 和 Teredo 搭配使用，但也適用於其他 IP 通道技術。</span><span class="sxs-lookup"><span data-stu-id="ca654-104">These changes are designed for use with IPv6 and Teredo, but they are also applicable to other IP tunneling technologies.</span></span> <span data-ttu-id="ca654-105">這些增強功能會影響 <xref:System.Net> 和相關命名空間中的類別。</span><span class="sxs-lookup"><span data-stu-id="ca654-105">These enhancements affect classes in the <xref:System.Net> and related namespaces.</span></span>  
  
 <span data-ttu-id="ca654-106">這些變更可能會影響計劃使用 IP 通道技術的用戶端和伺服器應用程式。</span><span class="sxs-lookup"><span data-stu-id="ca654-106">These changes can affect client and server applications that plan to use IP tunneling technologies.</span></span>  
  
 <span data-ttu-id="ca654-107">支援 NAT 周遊的變更只適用於使用 .NET Framework 第 4 版的應用程式。</span><span class="sxs-lookup"><span data-stu-id="ca654-107">The changes to support NAT traversal are available only for applications using .NET Framework version 4.</span></span> <span data-ttu-id="ca654-108">舊版 .NET Framework 無法使用這些功能。</span><span class="sxs-lookup"><span data-stu-id="ca654-108">These features are not available on earlier versions of the .NET Framework.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="ca654-109">總覽</span><span class="sxs-lookup"><span data-stu-id="ca654-109">Overview</span></span>  
 <span data-ttu-id="ca654-110">網際網路通訊協定第 4 版 (IPv4) 已將 IPv4 位址的長度定義為 32 位元。</span><span class="sxs-lookup"><span data-stu-id="ca654-110">The Internet Protocol version 4 (IPv4) defined an IPv4 address as 32 bits long.</span></span> <span data-ttu-id="ca654-111">因此，IPv4 大約支援 40 億個唯一 IP 位址 (2^32)。</span><span class="sxs-lookup"><span data-stu-id="ca654-111">As a result, IPv4 supports approximately 4 billion unique IP addresses (2^32).</span></span> <span data-ttu-id="ca654-112">因為網際網路上的電腦和網路裝置數目已在 1990 年代擴充，所以 IPv4 位址空間限制變得明顯。</span><span class="sxs-lookup"><span data-stu-id="ca654-112">As the number of computers and network devices on the Internet expanded in the 1990s, the limits of the IPv4 address space became apparent.</span></span>  
  
 <span data-ttu-id="ca654-113">數個用來擴充 IPv4 存留期的其中一個技術是部署 NAT，以允許單一唯一公用 IP 位址代表大量私人 IP 位址 (私人內部網路)。</span><span class="sxs-lookup"><span data-stu-id="ca654-113">One of several techniques used to extend the lifetime of IPv4 has been to deploy NAT to allow a single unique public IP address to represent a large number of private IP addresses (private Intranet).</span></span> <span data-ttu-id="ca654-114">受 NAT 裝置保護的私人 IP 位址會共用單一公用 IPv4 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-114">The private IP addresses behind the NAT device share the single public IPv4 address.</span></span> <span data-ttu-id="ca654-115">NAT 裝置可能是專用硬體裝置 (例如，便宜的無線存取點和路由器) 或執行服務來提供 NAT 的電腦。</span><span class="sxs-lookup"><span data-stu-id="ca654-115">The NAT device may be a dedicated hardware device (an inexpensive Wireless Access Point and router, for example) or a computer running a service to provide NAT.</span></span> <span data-ttu-id="ca654-116">此公用 IP 位址的裝置或服務會在公用網際網路與私人內部網路之間轉譯 IP 位址封包。</span><span class="sxs-lookup"><span data-stu-id="ca654-116">A device or service for this public IP address translates IP network packets between the public Internet and the private Intranet.</span></span>  
  
 <span data-ttu-id="ca654-117">此配置適用於在私人內部網路上執行的用戶端應用程式，而這些用戶端應用程式會將要求傳送給網際網路上的其他 IP 位址 (通常是伺服器)。</span><span class="sxs-lookup"><span data-stu-id="ca654-117">This scheme works well for client applications running on the private Intranet that send requests to other IP addresses (usually servers) on the Internet.</span></span> <span data-ttu-id="ca654-118">NAT 裝置或伺服器可以保留用戶端要求的對應；因此，它在傳回回應時會知道傳送回應的位置。</span><span class="sxs-lookup"><span data-stu-id="ca654-118">The NAT device or server can keep a mapping of client requests so when a response is returned it knows where to send the response.</span></span> <span data-ttu-id="ca654-119">但針對在受 NAT 裝置保護且想要提供服務、接聽封包以及回應之私人內部網路中執行的應用程式，此配置會造成問題。</span><span class="sxs-lookup"><span data-stu-id="ca654-119">But this scheme poses problems for applications running in the private Intranet behind the NAT device that want to provide services, listen for packets, and respond.</span></span> <span data-ttu-id="ca654-120">這是專用於對等應用程式的情況。</span><span class="sxs-lookup"><span data-stu-id="ca654-120">This is particularly the case for peer-to-peer applications.</span></span>  
  
 <span data-ttu-id="ca654-121">IPv6 通訊協定已將 IPv4 位址的長度定義為 128 位元。</span><span class="sxs-lookup"><span data-stu-id="ca654-121">The IPv6 protocol defined an IPv4 address as 128 bits long.</span></span> <span data-ttu-id="ca654-122">因此，IPv6 支援 3.2 x 10^38 唯一位址 (2^128) 的大型 IP 位址空間。</span><span class="sxs-lookup"><span data-stu-id="ca654-122">As a result, IPv6 supports very a large IP address space of 3.2 x 10^38 unique addresses (2^128).</span></span> <span data-ttu-id="ca654-123">有了此大小的位址空間之後，每個連線至網際網路的裝置就可能獲指定唯一位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-123">With an address space of this size, it is possible for every device connected to the Internet to be given a unique address.</span></span> <span data-ttu-id="ca654-124">但會發生問題。</span><span class="sxs-lookup"><span data-stu-id="ca654-124">But there are problems.</span></span> <span data-ttu-id="ca654-125">全世界大部分仍然都只使用 IPv4。</span><span class="sxs-lookup"><span data-stu-id="ca654-125">Much of the world is still using only IPv4.</span></span> <span data-ttu-id="ca654-126">特別的是，小型公司、組織和住家所使用的許多現有路由器和無線存取點都不支援 IPv6。</span><span class="sxs-lookup"><span data-stu-id="ca654-126">In particular, many of the existing routers and wireless access points used by small companies, organizations, and households do not support IPv6.</span></span> <span data-ttu-id="ca654-127">而且，有些服務這些客戶的網際網路服務提供者不支援或尚未設定 IPv6 支援。</span><span class="sxs-lookup"><span data-stu-id="ca654-127">Also some Internet service providers that serve these customers either do not support or have not configured support for IPv6.</span></span>  
  
 <span data-ttu-id="ca654-128">已開發數個 IPv6 轉換技術，對 IPv4 封包中的 IPv6 位址進行通道處理。</span><span class="sxs-lookup"><span data-stu-id="ca654-128">Several IPv6 transition technologies have been developed to tunnel IPv6 addresses in an IPv4 packet.</span></span> <span data-ttu-id="ca654-129">這些技術所包含的 6to4、ISATAP 和 Teredo 通道在 IPv6 主機必須周遊 IP4 網路以連線至其他 IPv6 網路時，提供單點傳播 IPv6 流量的位址指派以及主機對主機自動通道。</span><span class="sxs-lookup"><span data-stu-id="ca654-129">These technologies include 6to4, ISATAP, and Teredo tunnels that provide address assignment and host-to-host automatic tunneling for unicast IPv6 traffic when IPv6 hosts must traverse IP4 networks to reach other IPv6 networks.</span></span> <span data-ttu-id="ca654-130">IPv6 封包是以通道方式傳送為 IPv4 封包。</span><span class="sxs-lookup"><span data-stu-id="ca654-130">IPv6 packets are sent tunneled as IPv4 packets.</span></span> <span data-ttu-id="ca654-131">將會使用數個通道技術來允許透過 NAT 裝置進行 IPv6 位址的 NAT 周遊。</span><span class="sxs-lookup"><span data-stu-id="ca654-131">Several tunneling techniques are being used that allow NAT traversal for IPv6 addresses through a NAT device.</span></span>  
  
 <span data-ttu-id="ca654-132">Teredo 是其中一種 IPv6 轉換技術，具有與 IPv4 網路的 IPv6 連線。</span><span class="sxs-lookup"><span data-stu-id="ca654-132">Teredo is one of the IPv6 transition technologies which brings IPv6 connectivity to IPv4 networks.</span></span> <span data-ttu-id="ca654-133">網際網路工程任務推動小組 (IETF) 發行的 RFC 4380 中已記載 Teredo。</span><span class="sxs-lookup"><span data-stu-id="ca654-133">Teredo is documented in RFC 4380 published by the Internet Engineering Task Force (IETF).</span></span> <span data-ttu-id="ca654-134">Windows XP SP2 和更新版本所支援的虛擬 Teredo 配接器可以提供 2001:0::/32 範圍中的公用 IPv6 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-134">Windows XP SP2 and later provide support for a virtual Teredo adapter which can provide a public IPv6 address in the range 2001:0::/32.</span></span> <span data-ttu-id="ca654-135">這個 IPv6 位址可以用來接聽來自網際網路的連入連線，並且可以提供給具 IPv6 功能且想要連線至接聽端服務的用戶端。</span><span class="sxs-lookup"><span data-stu-id="ca654-135">This IPv6 address can be used to listen for incoming connections from the Internet and can be provided to IPv6 enabled clients that wish to connect to the listening service.</span></span> <span data-ttu-id="ca654-136">這讓應用程式不用擔心如何處理受 NAT 裝置保護的電腦，因為應用程式只能使用其 IPv6 Teredo 位址與之連線。</span><span class="sxs-lookup"><span data-stu-id="ca654-136">This frees an application from worrying about how to address a computer behind a NAT device, since the application can just connect to it using its IPv6 Teredo address.</span></span>  
  
## <a name="enhancements-to-support-nat-traversal-and-teredo"></a><span data-ttu-id="ca654-137">支援 NAT 周遊和 Teredo 的增強功能</span><span class="sxs-lookup"><span data-stu-id="ca654-137">Enhancements to Support NAT Traversal and Teredo</span></span>  
 <span data-ttu-id="ca654-138">在 <xref:System.Net>、<xref:System.Net.NetworkInformation> 和 <xref:System.Net.Sockets> 命名空間中新增增強功能，以支援使用 IPv6 和 Teredo 進行 NAT 周遊。</span><span class="sxs-lookup"><span data-stu-id="ca654-138">Enhancements are added to the <xref:System.Net>, <xref:System.Net.NetworkInformation>, and <xref:System.Net.Sockets> namespaces for supporting NAT traversal using IPv6 and Teredo.</span></span>  
  
 <span data-ttu-id="ca654-139"><xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> 類別中已新增數個方法，來取得主機上的單點傳播 IP 位址清單。</span><span class="sxs-lookup"><span data-stu-id="ca654-139">Several methods are added to the <xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> class to get the list of unicast IP addresses on the host.</span></span> <span data-ttu-id="ca654-140"><xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> 方法會開始非同步要求，以擷取本機電腦上的穩定單點傳播 IP 位址表格。</span><span class="sxs-lookup"><span data-stu-id="ca654-140">The <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> method begins an asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="ca654-141"><xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> 方法會結束暫止非同步要求，以擷取本機電腦上的穩定單點傳播 IP 位址表格。</span><span class="sxs-lookup"><span data-stu-id="ca654-141">The <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> method ends a pending asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="ca654-142"><xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> 方法是同步要求，以擷取本機電腦上的穩定單點傳播 IP 位址表格，並視需要等到位址表格穩定為止。</span><span class="sxs-lookup"><span data-stu-id="ca654-142">The <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> method is a synchronous request to retrieve the stable unicast IP address table on the local computer, waiting until the address table stabilizes if necessary.</span></span>  
  
 <span data-ttu-id="ca654-143"><xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType> 屬性可以用來判斷 <xref:System.Net.IPAddress> 是否為 IPv6 Teredo 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-143">The <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType> property can be used to determine if an <xref:System.Net.IPAddress> is an IPv6 Teredo address.</span></span>  
  
 <span data-ttu-id="ca654-144">搭配使用這些新 <xref:System.Net.NetworkInformation.IPGlobalProperties> 類別方法與 <xref:System.Net.IPAddress.IsIPv6Teredo%2A> 屬性，可讓應用程式輕鬆地找到 Teredo 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-144">Using these new <xref:System.Net.NetworkInformation.IPGlobalProperties> class methods in combination with the <xref:System.Net.IPAddress.IsIPv6Teredo%2A> property allows an application to easily find the Teredo address.</span></span> <span data-ttu-id="ca654-145">如果應用程式將這項資訊與遠端應用程式進行通訊，則通常只需要知道本機 Teredo 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-145">An application normally only needs to know the local Teredo address if it is communicating this information to remote applications.</span></span> <span data-ttu-id="ca654-146">例如，對等應用程式可能會將其所有 IPv6 位址傳送給配對伺服器，而配對伺服器接著可以將它們轉送給其他對等來啟用直接通訊。</span><span class="sxs-lookup"><span data-stu-id="ca654-146">For example, a peer-to-peer application might send all of its IPv6 addresses to a matchmaking server which can then forward them to others peers to enable direct communication.</span></span>  
  
 <span data-ttu-id="ca654-147">應用程式通常應該設定其接聽服務接聽 <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType>，而不是本機 Teredo 位址。</span><span class="sxs-lookup"><span data-stu-id="ca654-147">An application should normally set its listening service to listen on <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType> rather than on the local Teredo address.</span></span> <span data-ttu-id="ca654-148">因此，如果遠端用戶端或對等具有接聽服務主機的直接 IPv6 路由，則用戶端或對等可以使用 IPv6 直接連線，而不需要使用 Teredo 對封包進行通道處理。</span><span class="sxs-lookup"><span data-stu-id="ca654-148">So if a remote client or peer has a direct IPv6 route to the host of the listening service, the client or peer can connect directly using IPv6 and not have to use Teredo to tunnel packets.</span></span>  
  
 <span data-ttu-id="ca654-149">針對 TCP 應用程式，<xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType> 類別具有 <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> 方法來啟用 NAT 周遊。</span><span class="sxs-lookup"><span data-stu-id="ca654-149">For TCP applications, the <xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> method to enable NAT traversal.</span></span> <span data-ttu-id="ca654-150">針對 UDP 應用程式，<xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType> 類別具有 <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> 方法來啟用 NAT 周遊。</span><span class="sxs-lookup"><span data-stu-id="ca654-150">For UDP applications, the <xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> method to enable NAT traversal.</span></span>  
  
 <span data-ttu-id="ca654-151">針對使用 <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> 和相關類別的應用程式，可以搭配使用 <xref:System.Net.Sockets.Socket.GetSocketOption%2A> 和 <xref:System.Net.Sockets.Socket.SetSocketOption%2A> 方法與 <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType> 通訊端選項來查詢、啟用或停用 NAT 周遊。</span><span class="sxs-lookup"><span data-stu-id="ca654-151">For applications that use the <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> and related classes, the <xref:System.Net.Sockets.Socket.GetSocketOption%2A> and <xref:System.Net.Sockets.Socket.SetSocketOption%2A> methods can be used with the <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType> socket option to query, enable, or disable NAT traversal.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ca654-152">請參閱</span><span class="sxs-lookup"><span data-stu-id="ca654-152">See Also</span></span>  
 <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType>  
 <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A?displayProperty=nameWithType>  
 <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A?displayProperty=nameWithType>  
 <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A?displayProperty=nameWithType>  
 <xref:System.Net.Sockets.IPProtectionLevel?displayProperty=nameWithType>  
 <xref:System.Net.Sockets.Socket.SetIPProtectionLevel%2A?displayProperty=nameWithType>  
 <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A?displayProperty=nameWithType>  
 <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A?displayProperty=nameWithType>
