---
title: 工作流程中的模型化取消行為
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: ec0cf810693e2eda01a4c489b6eb938538719228
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/22/2019
ms.locfileid: "69965942"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="4ba97-102">工作流程中的模型化取消行為</span><span class="sxs-lookup"><span data-stu-id="4ba97-102">Modeling Cancellation Behavior in Workflows</span></span>
<span data-ttu-id="4ba97-103">活動可以在工作流程內部取消，例如，由 <xref:System.Activities.Statements.Parallel> 活動在它的 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 評估為 `true` 時來取消不完整的分支，或是從工作流程外部取消 (如果主機呼叫 <xref:System.Activities.WorkflowApplication.Cancel%2A>)。</span><span class="sxs-lookup"><span data-stu-id="4ba97-103">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="4ba97-104">若要提供取消處理，工作流程作者可以使用 <xref:System.Activities.Statements.CancellationScope> 活動、<xref:System.Activities.Statements.CompensableActivity> 活動或是建立可提供取消邏輯的自訂活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-104">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="4ba97-105">本主題提供工作流程取消的概觀。</span><span class="sxs-lookup"><span data-stu-id="4ba97-105">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="4ba97-106">取消、補償和異動</span><span class="sxs-lookup"><span data-stu-id="4ba97-106">Cancellation, Compensation, and Transactions</span></span>  
 <span data-ttu-id="4ba97-107">如果交易程序的任何部分發生錯誤，交易可讓應用程式中止 (回復) 在交易內部執行的所有變更。</span><span class="sxs-lookup"><span data-stu-id="4ba97-107">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="4ba97-108">但是，並非所有可能需要取消或復原的工作都適合異動使用，例如長時間執行的工作或是未牽涉到異動資源的工作。</span><span class="sxs-lookup"><span data-stu-id="4ba97-108">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="4ba97-109">補償會提供一個模型，可在工作流程發生後續失敗時，復原之前完成的非交易式工作。</span><span class="sxs-lookup"><span data-stu-id="4ba97-109">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="4ba97-110">取消會提供一個模型給工作流程和活動的作者使用，以便處理尚未完成的非異動式工作。</span><span class="sxs-lookup"><span data-stu-id="4ba97-110">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="4ba97-111">如果活動尚未完成執行而且遭到取消，則會叫用它的取消邏輯 (如果有的話)。</span><span class="sxs-lookup"><span data-stu-id="4ba97-111">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4ba97-112">如需交易和補償的詳細資訊, 請參閱[交易](workflow-transactions.md)和[補償](compensation.md)。</span><span class="sxs-lookup"><span data-stu-id="4ba97-112">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="4ba97-113">使用 CancellationScope</span><span class="sxs-lookup"><span data-stu-id="4ba97-113">Using CancellationScope</span></span>  
 <span data-ttu-id="4ba97-114"><xref:System.Activities.Statements.CancellationScope> 活動有兩個可以包含子活動的區段：<xref:System.Activities.Statements.CancellationScope.Body%2A> 和 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-114">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="4ba97-115"><xref:System.Activities.Statements.CancellationScope.Body%2A> (組成活動邏輯的活動所在的地方) 以及 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> (可提供活動取消邏輯之活動所在的地方)。</span><span class="sxs-lookup"><span data-stu-id="4ba97-115">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="4ba97-116">只有當活動尚未完成時才可以將它取消。</span><span class="sxs-lookup"><span data-stu-id="4ba97-116">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="4ba97-117">如果是 <xref:System.Activities.Statements.CancellationScope> 活動，完成指的是 <xref:System.Activities.Statements.CancellationScope.Body%2A> 中的活動完成。</span><span class="sxs-lookup"><span data-stu-id="4ba97-117">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="4ba97-118">如果排定了取消要求而且尚未完成 <xref:System.Activities.Statements.CancellationScope.Body%2A> 中的活動，則 <xref:System.Activities.Statements.CancellationScope> 將會標示為 <xref:System.Activities.ActivityInstanceState.Canceled> 而且將會執行 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-118">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="4ba97-119">從主機取消工作流程</span><span class="sxs-lookup"><span data-stu-id="4ba97-119">Canceling a Workflow from the Host</span></span>  
 <span data-ttu-id="4ba97-120">主機可以取消工作流程，其方式是呼叫正在裝載工作流程之 <xref:System.Activities.WorkflowApplication.Cancel%2A> 執行個體的 <xref:System.Activities.WorkflowApplication> 方法。</span><span class="sxs-lookup"><span data-stu-id="4ba97-120">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="4ba97-121">在下列範例中，將會建立一個具有 <xref:System.Activities.Statements.CancellationScope> 的工作流程。</span><span class="sxs-lookup"><span data-stu-id="4ba97-121">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="4ba97-122">將會叫用此工作流程，然後主機會呼叫 <xref:System.Activities.WorkflowApplication.Cancel%2A>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-122">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="4ba97-123">工作流程的主要執行工作會停止，並叫用 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 的 <xref:System.Activities.Statements.CancellationScope>，然後工作流程會完成而且狀態為 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-123">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="4ba97-124">當叫用這個工作流程時，主控台就會顯示下列輸出。</span><span class="sxs-lookup"><span data-stu-id="4ba97-124">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="4ba97-125">**啟動工作流程。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-125">**Starting the workflow.**</span></span>  
<span data-ttu-id="4ba97-126">**已叫用 CancellationHandler。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-126">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="4ba97-127">**已取消工作流程 b30ebb30-df46-4d90-a211-e31c38d8db3c。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-127">**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>    
> [!NOTE]
> <span data-ttu-id="4ba97-128">當取消 <xref:System.Activities.Statements.CancellationScope> 活動並叫用 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 時，工作流程作者必須判斷此活動取消之前所完成的進度，才能提供適當的取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="4ba97-129"><xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 不會提供有關取消之活動進度的任何資訊。</span><span class="sxs-lookup"><span data-stu-id="4ba97-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="4ba97-130">如果未處理的例外狀況反昇而超過工作流程的根，而且 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 處理常式傳回 <xref:System.Activities.UnhandledExceptionAction.Cancel>，也可以取消工作流程。</span><span class="sxs-lookup"><span data-stu-id="4ba97-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="4ba97-131">在這個範例中，工作流程會啟動然後擲回 <xref:System.ApplicationException>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="4ba97-132">工作流程未處理這個例外狀況，所以叫用了 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 處理常式。</span><span class="sxs-lookup"><span data-stu-id="4ba97-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="4ba97-133">此處理常式會指示執行階段取消工作流程，而且會叫用目前執行之 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 活動的 <xref:System.Activities.Statements.CancellationScope>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="4ba97-134">當叫用這個工作流程時，主控台就會顯示下列輸出。</span><span class="sxs-lookup"><span data-stu-id="4ba97-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="4ba97-135">**啟動工作流程。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="4ba97-136">**工作流程6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 中的6Bb2d5d6-f49a-4c6d-a988-478afb86dbe9** </span><span class="sxs-lookup"><span data-stu-id="4ba97-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** </span></span>  
<span data-ttu-id="4ba97-137">**已擲回 ApplicationException。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-137">**An ApplicationException was thrown.** </span></span>  
<span data-ttu-id="4ba97-138">**已叫用 CancellationHandler。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-138">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="4ba97-139">**已取消工作流程6bb2d5d6-f49a-4c6d-a988-478afb86dbe9。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-139">**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>    
### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="4ba97-140">從工作流程內部取消活動</span><span class="sxs-lookup"><span data-stu-id="4ba97-140">Canceling an Activity from Inside a Workflow</span></span>  
 <span data-ttu-id="4ba97-141">活動的父系也可以取消該活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-141">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="4ba97-142">例如，如果 <xref:System.Activities.Statements.Parallel> 活動有多個執行中的分支，而且它的 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 評估為 `true`，將會取消不完整的分支。</span><span class="sxs-lookup"><span data-stu-id="4ba97-142">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="4ba97-143">在這個範例中，將會建立具有兩個分支的 <xref:System.Activities.Statements.Parallel> 活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-143">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="4ba97-144">它的 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 會設定為 `true`，所以一旦它的任何一個分支完成時，<xref:System.Activities.Statements.Parallel> 就會完成。</span><span class="sxs-lookup"><span data-stu-id="4ba97-144">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="4ba97-145">在這個範例中，分支 2 完成，所以分支 1 遭到取消。</span><span class="sxs-lookup"><span data-stu-id="4ba97-145">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="4ba97-146">當叫用這個工作流程時，主控台就會顯示下列輸出。</span><span class="sxs-lookup"><span data-stu-id="4ba97-146">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="4ba97-147">**分支1開始。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-147">**Branch 1 starting.**</span></span>  
<span data-ttu-id="4ba97-148">**分支2完成。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-148">**Branch 2 complete.** </span></span>  
<span data-ttu-id="4ba97-149">**分支1已取消。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-149">**Branch 1 canceled.** </span></span>  
<span data-ttu-id="4ba97-150">**工作流程 e0685e24-18ef-4a47-acf3-5c638732f3be 已完成。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-150">**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="4ba97-151">如果例外狀況反昇而超過活動的根，但是在工作流程的更高層處理，也會取消活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-151">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="4ba97-152">在這個範例中，工作流程的主要邏輯是由 <xref:System.Activities.Statements.Sequence> 活動所組成。</span><span class="sxs-lookup"><span data-stu-id="4ba97-152">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="4ba97-153"><xref:System.Activities.Statements.Sequence> 會指定為 <xref:System.Activities.Statements.CancellationScope.Body%2A> 活動的 <xref:System.Activities.Statements.CancellationScope>，該活動包含在 <xref:System.Activities.Statements.TryCatch> 活動中。</span><span class="sxs-lookup"><span data-stu-id="4ba97-153">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="4ba97-154">從 <xref:System.Activities.Statements.Sequence> 的主體擲回例外狀況，且會由父活動 <xref:System.Activities.Statements.TryCatch> 所處理，並取消 <xref:System.Activities.Statements.Sequence>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-154">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="4ba97-155">當叫用這個工作流程時，主控台就會顯示下列輸出。</span><span class="sxs-lookup"><span data-stu-id="4ba97-155">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="4ba97-156">**序列開始。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-156">**Sequence starting.**</span></span>  
<span data-ttu-id="4ba97-157">**已取消序列。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-157">**Sequence canceled.** </span></span>  
<span data-ttu-id="4ba97-158">**攔截到例外狀況。**  </span><span class="sxs-lookup"><span data-stu-id="4ba97-158">**Exception caught.** </span></span>  
<span data-ttu-id="4ba97-159">**工作流程 e3c18939-121e-4c43-af1c-ba1ce977ce55 已完成。**</span><span class="sxs-lookup"><span data-stu-id="4ba97-159">**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>   
### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="4ba97-160">從 CancellationHandler 擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4ba97-160">Throwing Exceptions from a CancellationHandler</span></span>  
 <span data-ttu-id="4ba97-161">從 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 的 <xref:System.Activities.Statements.CancellationScope> 擲回的任何例外狀況對工作流程都很重要。</span><span class="sxs-lookup"><span data-stu-id="4ba97-161">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="4ba97-162">如果例外狀況有可能從 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 逸出，請在 <xref:System.Activities.Statements.TryCatch> 中使用 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 來攔截及處理這些例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4ba97-162">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="4ba97-163">使用 CompensableActivity 取消</span><span class="sxs-lookup"><span data-stu-id="4ba97-163">Cancellation using CompensableActivity</span></span>  
 <span data-ttu-id="4ba97-164">就像 <xref:System.Activities.Statements.CancellationScope> 活動一樣，<xref:System.Activities.Statements.CompensableActivity> 具有 <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-164">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="4ba97-165">如果取消了 <xref:System.Activities.Statements.CompensableActivity>，將會叫用其 <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> 中的任何活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-165">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="4ba97-166">這對於復原部分完成的可補償工作很有用處。</span><span class="sxs-lookup"><span data-stu-id="4ba97-166">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="4ba97-167">如需如何使用<xref:System.Activities.Statements.CompensableActivity>進行補償和取消的詳細資訊, 請參閱[補償](compensation.md)。</span><span class="sxs-lookup"><span data-stu-id="4ba97-167">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="4ba97-168">使用自訂活動取消</span><span class="sxs-lookup"><span data-stu-id="4ba97-168">Cancellation using Custom Activities</span></span>  
 <span data-ttu-id="4ba97-169">自訂活動作者可以透過幾個方法，將取消邏輯實作到自訂活動中。</span><span class="sxs-lookup"><span data-stu-id="4ba97-169">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="4ba97-170">從 <xref:System.Activities.Activity> 衍生的自訂活動可以實作取消邏輯，方法是將 <xref:System.Activities.Statements.CancellationScope> 或其他包含取消邏輯的自訂活動放在活動的主體內。</span><span class="sxs-lookup"><span data-stu-id="4ba97-170">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="4ba97-171"><xref:System.Activities.AsyncCodeActivity> 和 <xref:System.Activities.NativeActivity> 衍生活動可以覆寫其各自的 <xref:System.Activities.NativeActivity.Cancel%2A> 方法，並在這裡提供取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-171"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="4ba97-172"><xref:System.Activities.CodeActivity> 衍生活動不會提供任何取消的規定，因為其所有工作都是在執行階段呼叫 <xref:System.Activities.CodeActivity.Execute%2A> 方法時，於單一執行中執行。</span><span class="sxs-lookup"><span data-stu-id="4ba97-172"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="4ba97-173">如果尚未呼叫執行方法，而且取消了根據 <xref:System.Activities.CodeActivity> 的活動，此活動會關閉且狀態為 <xref:System.Activities.ActivityInstanceState.Canceled>，而且不會呼叫 <xref:System.Activities.CodeActivity.Execute%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="4ba97-173">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="4ba97-174">使用 NativeActivity 取消</span><span class="sxs-lookup"><span data-stu-id="4ba97-174">Cancellation using NativeActivity</span></span>  
 <span data-ttu-id="4ba97-175"><xref:System.Activities.NativeActivity> 衍生活動可以覆寫 <xref:System.Activities.NativeActivity.Cancel%2A> 方法來提供自訂取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-175"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="4ba97-176">如果這個方法未遭到覆寫，則會套用預設工作流程取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-176">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="4ba97-177"><xref:System.Activities.NativeActivity>預設取消是針對未覆<xref:System.Activities.NativeActivity.Cancel%2A>寫方法或其<xref:System.Activities.NativeActivity.Cancel%2A>方法呼叫基底<xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A>方法的所發生的進程。</span><span class="sxs-lookup"><span data-stu-id="4ba97-177">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="4ba97-178">當取消某個活動時，執行階段會將此活動標示為將要取消，而且會自動處理某些清除工作。</span><span class="sxs-lookup"><span data-stu-id="4ba97-178">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="4ba97-179">如果此活動只有待處理的書籤，這些書籤將會被移除，而且此活動將會標示為 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-179">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="4ba97-180">接著會取消已取消之活動的任何待處理的子活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-180">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="4ba97-181">嘗試排定其他子活動的任何動作都會遭到忽略，而且此活動會標示為 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-181">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="4ba97-182">如果有任何待處理的子活動在 <xref:System.Activities.ActivityInstanceState.Canceled> 或 <xref:System.Activities.ActivityInstanceState.Faulted> 狀態下完成，此活動會標示為 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-182">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="4ba97-183">請注意，可以忽略取消要求。</span><span class="sxs-lookup"><span data-stu-id="4ba97-183">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="4ba97-184">如果某個活動沒有任何待處理的書籤或是執行中的子活動，而且被標示為將要取消之後也沒有排定任何其他工作項目，此活動將會順利完成。</span><span class="sxs-lookup"><span data-stu-id="4ba97-184">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="4ba97-185">在許多案例中，這個預設取消作業就足夠了，但是如果需要其他取消邏輯，則可以使用內建取消活動或自訂活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-185">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="4ba97-186">在下列範例中，將會定義 <xref:System.Activities.NativeActivity.Cancel%2A> 型自訂 <xref:System.Activities.NativeActivity> 活動的 `ParallelForEach` 覆寫。</span><span class="sxs-lookup"><span data-stu-id="4ba97-186">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="4ba97-187">當取消活動時，這個覆寫會處理該活動的取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-187">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="4ba97-188">這個範例是[非泛型 ParallelForEach](./samples/non-generic-parallelforeach.md)範例的一部分。</span><span class="sxs-lookup"><span data-stu-id="4ba97-188">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="4ba97-189"><xref:System.Activities.NativeActivity> 衍生活動可以檢查 <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> 屬性來判斷是否已經要求取消，並呼叫 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> 方法來將其本身標示為已取消。</span><span class="sxs-lookup"><span data-stu-id="4ba97-189"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="4ba97-190">呼叫 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> 不會立即完成活動。</span><span class="sxs-lookup"><span data-stu-id="4ba97-190">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="4ba97-191">通常執行階段會在沒有其他待處理工作時完成此活動，但是如果呼叫 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>，最終的狀態將會是 <xref:System.Activities.ActivityInstanceState.Canceled> 而不是 <xref:System.Activities.ActivityInstanceState.Closed>。</span><span class="sxs-lookup"><span data-stu-id="4ba97-191">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="4ba97-192">使用 AsyncCodeActivity 取消</span><span class="sxs-lookup"><span data-stu-id="4ba97-192">Cancellation using AsyncCodeActivity</span></span>  
 <span data-ttu-id="4ba97-193"><xref:System.Activities.AsyncCodeActivity> 型活動也可以藉由覆寫 <xref:System.Activities.AsyncCodeActivity.Cancel%2A> 方法來提供自訂取消邏輯。</span><span class="sxs-lookup"><span data-stu-id="4ba97-193"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="4ba97-194">如果這個方法未遭到覆寫，此活動已取消時不會執行任何取消處理動作。</span><span class="sxs-lookup"><span data-stu-id="4ba97-194">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="4ba97-195">在下列範例中，將會定義 <xref:System.Activities.AsyncCodeActivity.Cancel%2A> 型自訂 <xref:System.Activities.AsyncCodeActivity> 活動的 `ExecutePowerShell` 覆寫。</span><span class="sxs-lookup"><span data-stu-id="4ba97-195">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="4ba97-196">當取消此活動時，它會執行所要的取消行為。</span><span class="sxs-lookup"><span data-stu-id="4ba97-196">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="4ba97-197"><xref:System.Activities.AsyncCodeActivity> 衍生活動可以檢查 <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> 屬性來判斷是否已經要求取消，並呼叫 <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> 方法來將其本身標示為已取消。</span><span class="sxs-lookup"><span data-stu-id="4ba97-197"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
