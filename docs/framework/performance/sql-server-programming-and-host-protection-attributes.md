---
title: SQL Server 程式設計和主機保護屬性
ms.date: 03/30/2017
helpviewer_keywords:
- SQL Server [.NET Framework]
- permission sets, SQL Server
- SQL Server Programming and Host Protection Attributes
- managed code, SQL Server
- reliability [.NET Framework]
- writing reliable code
- hosts, reliability
- host protection attributes
- HostProtectionAttribute class, reliability
ms.assetid: 7dfa36b4-e773-4c75-a3ff-ff1af3ce4c4f
author: mairaw
ms.author: mairaw
ms.openlocfilehash: aafd494a2330609f68295588cf649bc4666f4cfe
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/28/2019
ms.locfileid: "64614885"
---
# <a name="sql-server-programming-and-host-protection-attributes"></a>SQL Server 程式設計和主機保護屬性
在 SQL Server 主機中載入和執行 Managed 程式碼的功能需要符合主機對程式碼存取安全性和主機資源保護的需求。  三個 SQL Server 權限集的其中一個指定的程式碼存取安全性需求：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。 在 SAFE 或 EXTERNAL-ACCESS 權限集合內執行的程式碼，必須避免已套用 <xref:System.Security.Permissions.HostProtectionAttribute> 屬性的特定類型或成員。 <xref:System.Security.Permissions.HostProtectionAttribute> 不像可靠性保證一樣是安全性權限，關鍵在於它會識別主機可能不允許的特定程式碼建構 (類型或方法)。  使用 <xref:System.Security.Permissions.HostProtectionAttribute> 會強制使用有助於保護主機穩定性的程式設計模型。  
  
## <a name="host-protection-attributes"></a>主機保護屬性  
 主機保護屬性可識別不適合主機程式設計模型的類型或成員，並且代表下列遞增的可靠性威脅層級：  
  
- 不是良性。  
  
- 可能會導致伺服器管理的使用者程式碼不穩定。  
  
- 可能會導致伺服器處理序本身不穩定。  
  
 SQL Server 不允許使用具有 <xref:System.Security.Permissions.HostProtectionAttribute> 且其 <xref:System.Security.Permissions.HostProtectionResource> 值指定為 <xref:System.Security.Permissions.HostProtectionResource.SharedState>、<xref:System.Security.Permissions.HostProtectionResource.Synchronization>、<xref:System.Security.Permissions.HostProtectionResource.MayLeakOnAbort> 或 <xref:System.Security.Permissions.HostProtectionResource.ExternalProcessMgmt> 的類型或成員。 這可防止組件呼叫可啟用共用狀態、執行同步處理、可能造成終止時資源流失，或影響 SQL Server 程序完整性的成員。  
  
### <a name="disallowed-types-and-members"></a>不允許的類型和成員  
 下表提供 SQL Server 不允許其 <xref:System.Security.Permissions.HostProtectionResource> 值的類型和成員。  
  
|命名空間|類型或成員|  
|---------------|--------------------|  
|`Microsoft.Win32`|<xref:Microsoft.Win32.PowerModeChangedEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.PowerModeChangedEventHandler> 委派<br /><br /> <xref:Microsoft.Win32.SessionEndedEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.SessionEndedEventHandler> 委派<br /><br /> <xref:Microsoft.Win32.SessionEndingEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.SessionEndingEventHandler> 委派<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventHandler> 委派<br /><br /> <xref:Microsoft.Win32.SystemEvents> 類別<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventHandler> 委派<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangedEventArgs> 類別<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangingEventArgs> 類別|  
|`System.Collections`|<xref:System.Collections.ArrayList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Hashtable.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Queue.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.SortedList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Stack.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.ComponentModel`|<xref:System.ComponentModel.AddingNewEventArgs> 類別<br /><br /> <xref:System.ComponentModel.AddingNewEventHandler> 委派<br /><br /> <xref:System.ComponentModel.ArrayConverter> 類別<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.AsyncOperation> 類別<br /><br /> <xref:System.ComponentModel.AsyncOperationManager> 類別<br /><br /> <xref:System.ComponentModel.AttributeCollection> 類別<br /><br /> <xref:System.ComponentModel.BackgroundWorker> 類別<br /><br /> <xref:System.ComponentModel.BaseNumberConverter> 類別<br /><br /> <xref:System.ComponentModel.BindingList%601> 類別<br /><br /> <xref:System.ComponentModel.BooleanConverter> 類別<br /><br /> <xref:System.ComponentModel.ByteConverter> 類別<br /><br /> <xref:System.ComponentModel.CancelEventArgs> 類別<br /><br /> <xref:System.ComponentModel.CancelEventHandler> 委派<br /><br /> <xref:System.ComponentModel.CharConverter> 類別<br /><br /> <xref:System.ComponentModel.CollectionChangeEventArgs> 類別<br /><br /> <xref:System.ComponentModel.CollectionChangeEventHandler> 委派<br /><br /> <xref:System.ComponentModel.CollectionConverter> 類別<br /><br /> <xref:System.ComponentModel.ComponentCollection> 類別<br /><br /> <xref:System.ComponentModel.ComponentConverter> 類別<br /><br /> <xref:System.ComponentModel.ComponentEditor> 類別<br /><br /> <xref:System.ComponentModel.ComponentResourceManager> 類別<br /><br /> <xref:System.ComponentModel.Container> 類別<br /><br /> <xref:System.ComponentModel.ContainerFilterService> 類別<br /><br /> <xref:System.ComponentModel.CultureInfoConverter> 類別<br /><br /> <xref:System.ComponentModel.CustomTypeDescriptor> 類別<br /><br /> <xref:System.ComponentModel.DateTimeConverter> 類別<br /><br /> <xref:System.ComponentModel.DecimalConverter> 類別<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.CheckoutException> 類別<br /><br /> <xref:System.ComponentModel.Design.CommandID> 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerCollection> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerOptionService> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransaction> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.DesignerVerb> 類別<br /><br /> <xref:System.ComponentModel.Design.DesignerVerbCollection> 類別<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContext> 類別<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContextSerializer> 類別<br /><br /> <xref:System.ComponentModel.Design.MenuCommand> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ComponentSerializationService> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ContextStack> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.DesignerLoader> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.InstanceDescriptor> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.MemberRelationshipService> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventArgs> 類別<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventHandler> 委派<br /><br /> <xref:System.ComponentModel.Design.Serialization.SerializationStore> 類別<br /><br /> <xref:System.ComponentModel.Design.ServiceContainer> 類別<br /><br /> <xref:System.ComponentModel.Design.ServiceCreatorCallback> 委派<br /><br /> <xref:System.ComponentModel.Design.StandardCommands> 類別<br /><br /> <xref:System.ComponentModel.Design.StandardToolWindows> 類別<br /><br /> <xref:System.ComponentModel.DoubleConverter> 類別<br /><br /> <xref:System.ComponentModel.DoWorkEventArgs> 類別<br /><br /> <xref:System.ComponentModel.DoWorkEventHandler> 委派<br /><br /> <xref:System.ComponentModel.EnumConverter> 類別<br /><br /> <xref:System.ComponentModel.EventDescriptor> 類別<br /><br /> <xref:System.ComponentModel.EventDescriptorCollection> 類別<br /><br /> <xref:System.ComponentModel.EventHandlerList> 類別<br /><br /> <xref:System.ComponentModel.ExpandableObjectConverter> 類別<br /><br /> <xref:System.ComponentModel.HandledEventArgs> 類別<br /><br /> <xref:System.ComponentModel.HandledEventHandler> 委派<br /><br /> <xref:System.ComponentModel.InstanceCreationEditor> 類別<br /><br /> <xref:System.ComponentModel.Int16Converter> 類別<br /><br /> <xref:System.ComponentModel.Int32Converter> 類別<br /><br /> <xref:System.ComponentModel.Int64Converter> 類別<br /><br /> <xref:System.ComponentModel.InvalidAsynchronousStateException> 類別<br /><br /> <xref:System.ComponentModel.InvalidEnumArgumentException> 類別<br /><br /> <xref:System.ComponentModel.ISynchronizeInvoke.BeginInvoke%2A> 方法<br /><br /> <xref:System.ComponentModel.License> 類別<br /><br /> <xref:System.ComponentModel.LicenseContext> 類別<br /><br /> <xref:System.ComponentModel.LicenseException> 類別<br /><br /> <xref:System.ComponentModel.LicenseManager> 類別<br /><br /> <xref:System.ComponentModel.LicenseProvider> 類別<br /><br /> <xref:System.ComponentModel.LicFileLicenseProvider> 類別<br /><br /> <xref:System.ComponentModel.ListChangedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.ListChangedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.ListSortDescription> 類別<br /><br /> <xref:System.ComponentModel.ListSortDescriptionCollection> 類別<br /><br /> <xref:System.ComponentModel.MaskedTextProvider> 類別<br /><br /> <xref:System.ComponentModel.MemberDescriptor> 類別<br /><br /> <xref:System.ComponentModel.MultilineStringConverter> 類別<br /><br /> <xref:System.ComponentModel.NestedContainer> 類別<br /><br /> <xref:System.ComponentModel.NullableConverter> 類別<br /><br /> <xref:System.ComponentModel.ProgressChangedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.ProgressChangedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.PropertyChangedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.PropertyChangedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.PropertyDescriptor> 類別<br /><br /> <xref:System.ComponentModel.PropertyDescriptorCollection> 類別<br /><br /> <xref:System.ComponentModel.ReferenceConverter> 類別<br /><br /> <xref:System.ComponentModel.RefreshEventArgs> 類別<br /><br /> <xref:System.ComponentModel.RefreshEventHandler> 委派<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventArgs> 類別<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventHandler> 委派<br /><br /> <xref:System.ComponentModel.SByteConverter> 類別<br /><br /> <xref:System.ComponentModel.SingleConverter> 類別<br /><br /> <xref:System.ComponentModel.StringConverter> 類別<br /><br /> <xref:System.ComponentModel.SyntaxCheck> 類別<br /><br /> <xref:System.ComponentModel.TimeSpanConverter> 類別<br /><br /> <xref:System.ComponentModel.TypeConverter> 類別<br /><br /> <xref:System.ComponentModel.TypeDescriptionProvider> 類別<br /><br /> <xref:System.ComponentModel.TypeDescriptor> 類別<br /><br /> <xref:System.ComponentModel.TypeListConverter> 類別<br /><br /> <xref:System.ComponentModel.UInt16Converter> 類別<br /><br /> <xref:System.ComponentModel.UInt32Converter> 類別<br /><br /> <xref:System.ComponentModel.UInt64Converter> 類別<br /><br /> <xref:System.ComponentModel.WarningException> 類別<br /><br /> <xref:System.ComponentModel.Win32Exception> 類別|  
|`System.Diagnostics`|<xref:System.Diagnostics.Debug.Listeners%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.Trace.Listeners%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.EventLog.SynchronizingObject%2A?displayProperty=nameWithType> 屬性<br /><br /> <xref:System.Diagnostics.ConsoleTraceListener> 類別<br /><br /> <xref:System.Diagnostics.DefaultTraceListener> 類別<br /><br /> <xref:System.Diagnostics.DelimitedListTraceListener> 類別<br /><br /> <xref:System.Diagnostics.EventLogTraceListener> 類別<br /><br /> <xref:System.Diagnostics.PerformanceCounter> 類別<br /><br /> <xref:System.Diagnostics.PerformanceCounterCategory> 類別<br /><br /> <xref:System.Diagnostics.Process> 類別<br /><br /> <xref:System.Diagnostics.ProcessStartInfo> 類別<br /><br /> <xref:System.Diagnostics.TextWriterTraceListener> 類別<br /><br /> <xref:System.Diagnostics.TraceListener> 類別<br /><br /> <xref:System.Diagnostics.XmlWriterTraceListener> 類別<br /><br /> <xref:System.Diagnostics.TraceSource.Listeners%2A?displayProperty=nameWithType> 屬性|  
|`System.IO`|<xref:System.IO.Stream.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextReader.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextWriter.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Reflection.Emit`|<xref:System.Reflection.Emit.ConstructorBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.EventBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.FieldBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.MethodBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.CustomAttributeBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.MethodRental> 類別<br /><br /> <xref:System.Reflection.Emit.ModuleBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.PropertyBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.TypeBuilder> 類別<br /><br /> <xref:System.Reflection.Emit.UnmanagedMarshal> 類別|  
|`System.Text`|<xref:System.Text.RegularExpressions.Group.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Text.RegularExpressions.Match.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Threading`|<xref:System.Threading.AutoResetEvent> 類別<br /><br /> <xref:System.Threading.EventWaitHandle> 類別<br /><br /> <xref:System.Threading.ManualResetEvent> 類別<br /><br /> <xref:System.Threading.Monitor> 類別<br /><br /> <xref:System.Threading.Mutex> 類別<br /><br /> <xref:System.Threading.ReaderWriterLock> 類別<br /><br /> <xref:System.Threading.Semaphore> 類別<br /><br /> <xref:System.Threading.Thread.AllocateNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.BeginCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.EndCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.FreeNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.GetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SpinWait%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Start%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.TrySetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.ThreadPool> 類別<br /><br /> <xref:System.Threading.Timer> 類別|  
|`System.Timers`|<xref:System.Timers.Timer> 類別|  
|`System.Web.Configuration`|<xref:System.Web.Configuration.MachineKeyValidationConverter> 類別|  
|`System.Windows.Forms`|<xref:System.Windows.Forms.AutoCompleteStringCollection.SyncRoot%2A?displayProperty=nameWithType> 屬性|  
  
## <a name="sql-server-permission-sets"></a>SQL Server 權限集合  
 SQL Server 可讓使用者針對部署到資料庫中的程式碼指定可靠性需求。 當組件上傳至資料庫時，組件作者可以指定三個權限集合的其中一個該組件：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。  
  
|權限集合|SAFE|EXTERNAL-ACCESS|UNSAFE|  
|--------------------|----------|----------------------|------------|  
|程式碼存取安全性|僅限執行|執行 + 存取外部資源|無限制的|  
|程式設計模型限制|是|是|無限制|  
|可驗證性需求|是|是|否|  
|呼叫原生程式碼的能力|否|否|是|  
  
 SAFE 是最可靠且安全的模式，並且在允許的程式設計模型方面有相關限制。 SAFE 程式碼具有高可靠性和安全性功能。 SAFE 組件有足夠的權限來執行、執行計算，以及存取本機資料庫。 SAFE 組件必須是可驗證的型別安全，且不允許呼叫 Unmanaged 程式碼。  
  
 EXTERNAL-ACCESS 提供了中級安全性選項，允許程式碼存取資料庫之外的資源，但仍然保有 SAFE 的可靠性和安全性。  
  
 UNSAFE 適用於只能由資料庫管理員建立的高度信任程式碼。 此受信任的程式碼沒有程式碼存取限制，且可以呼叫 Unmanaged (原生) 程式碼。  
  
 SQL Server 使用主機層級程式碼存取安全性原則層來設定主機原則，根據儲存在 SQL Server 目錄的權限集合，授與三個權限集合的其中一個。 在資料庫內執行的 Managed 程式碼一律會取得這些程式碼存取權限集合的其中一個。  
  
## <a name="programming-model-restrictions"></a>程式設計模型限制  
 SQL Server 中的 Managed 程式碼程式設計模型需要的函式、程序和類型，不需要使用跨多個引動過程保留的狀態，或是在多個使用者工作階段之間共用狀態。 此外，如先前所述，共用狀態的存在可能會導致嚴重的例外狀況，影響應用程式的延展性和可靠性。  
  
 基於這些考量，SQL Server 不允許使用靜態變數和靜態資料成員。 對於 SAFE 及 EXTERNAL-ACCESS 組件，SQL Server 會在 CREATE ASSEMBLY 時，檢查組件的中繼資料，並且如果它找到使用靜態資料成員和變數，便讓這類組件的建立作業失敗。  
  
## <a name="see-also"></a>另請參閱

- <xref:System.Security.Permissions.HostProtectionAttribute>
- <xref:System.Security.Permissions.HostProtectionResource>
